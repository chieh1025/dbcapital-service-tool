<!DOCTYPE html>
<html lang="zh-TW">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è‚¡å‹™å°å¹«æ‰‹</title>
    <!-- Libraries -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>

    <style>
        :root {
            /* Tailwind-like Palette (Slate & Blue) */
            --bg-body: #f1f5f9;
            /* slate-100 */
            --bg-card: #ffffff;
            --text-main: #1e293b;
            /* slate-800 */
            --text-sub: #64748b;
            /* slate-500 */

            --primary: #2563eb;
            /* blue-600 */
            --primary-light: #eff6ff;
            /* blue-50 */
            --primary-hover: #1d4ed8;
            /* blue-700 */

            --success: #059669;
            /* emerald-600 */
            --success-bg: #ecfdf5;
            /* emerald-50 */
            --danger: #dc2626;
            /* red-600 */
            --danger-bg: #fef2f2;
            /* red-50 */

            --border: #cbd5e1;
            /* slate-300 */
            --radius: 12px;
            --shadow: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1);
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            background-color: var(--bg-body);
            color: var(--text-main);
            margin: 0;
            padding: 20px;
            min-height: 100vh;
            display: flex;
            justify-content: center;
        }

        .container {
            width: 100%;
            max-width: 650px;
            /* Slightly wider for hybrid features */
            background: var(--bg-card);
            border-radius: var(--radius);
            box-shadow: var(--shadow);
            padding: 30px;
            position: relative;
        }

        /* Header */
        .header {
            text-align: center;
            margin-bottom: 30px;
            position: relative;
        }

        .header h1 {
            font-size: 28px;
            font-weight: 800;
            color: var(--text-main);
            margin: 0;
            letter-spacing: -0.5px;
        }

        .admin-trigger {
            position: absolute;
            right: 0;
            top: 0;
            opacity: 0.1;
            cursor: pointer;
            padding: 5px;
        }

        .admin-trigger:hover {
            opacity: 0.5;
        }

        /* Tabs (Refined Pill Style) */
        .tabs {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-bottom: 25px;
        }

        .tab {
            flex: 1 1 auto;
            padding: 10px 16px;
            text-align: center;
            font-size: 15px;
            font-weight: 600;
            background: #f8fafc;
            color: var(--text-sub);
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s ease;
            border: 1px solid transparent;
        }

        .tab:hover {
            background: #e2e8f0;
            color: var(--text-main);
        }

        .tab.active {
            background: var(--bg-card);
            color: var(--primary);
            border-color: var(--primary);
            box-shadow: 0 4px 6px -1px rgba(37, 99, 235, 0.1);
        }

        .tab-content {
            display: none;
            animation: fadeIn 0.3s ease;
        }

        .tab-content.active {
            display: block;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(5px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* Common UI Elements */
        .card {
            background: #ffffff;
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
            position: relative;
        }

        .btn {
            width: 100%;
            padding: 12px;
            background: var(--primary);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        .btn:hover {
            background: var(--primary-hover);
            transform: translateY(-1px);
        }

        .btn.outline {
            background: transparent;
            border: 2px solid var(--text-main);
            color: var(--text-main);
        }

        .btn.outline:hover {
            background: var(--bg-body);
        }

        .input-group {
            margin-bottom: 20px;
        }

        .input-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            font-size: 14px;
            color: var(--text-sub);
        }

        input,
        select {
            width: 100%;
            padding: 12px;
            border: 1px solid var(--border);
            border-radius: 8px;
            font-size: 16px;
            background: #fff;
            box-sizing: border-box;
            transition: border-color 0.2s;
        }

        input:focus {
            outline: none;
            border-color: var(--primary);
            ring: 2px var(--primary-light);
        }

        /* --- Special: Timeline Accordion --- */
        .timeline-box {
            background: var(--primary-light);
            border-left: 4px solid var(--primary);
            border-radius: 0 8px 8px 0;
            margin-bottom: 25px;
            overflow: hidden;
        }

        .timeline-header {
            padding: 15px;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-weight: 700;
            color: #1e3a8a;
            /* dark blue */
        }

        .timeline-content {
            height: 0;
            overflow: hidden;
            transition: height 0.3s ease-out;
            padding: 0 15px;
            /* Padding added via JS when open */
        }

        .timeline-content ul {
            list-style: none;
            padding: 0;
            margin: 0 0 15px 0;
        }

        .timeline-content li {
            position: relative;
            padding-left: 20px;
            margin-bottom: 10px;
            font-size: 14px;
            color: #334155;
        }

        .timeline-content li:before {
            content: "â€¢";
            position: absolute;
            left: 0;
            color: var(--primary);
            font-weight: bold;
        }

        /* --- Special: Slider Checkbox --- */
        .slider-row {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 15px;
            background: #fff;
            border: 1px solid var(--border);
            border-radius: 8px;
        }

        .switch {
            position: relative;
            display: inline-block;
            width: 50px;
            height: 28px;
        }

        .switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #cbd5e1;
            transition: .4s;
            border-radius: 34px;
        }

        .slider:before {
            position: absolute;
            content: "";
            height: 20px;
            width: 20px;
            left: 4px;
            bottom: 4px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }

        input:checked+.slider {
            background-color: var(--success);
        }

        input:checked+.slider:before {
            transform: translateX(22px);
        }

        /* --- Special: Confirmation Sheet (Visual) --- */
        .conf-sheet {
            border: 4px solid var(--text-main);
            border-radius: 12px;
            padding: 25px;
            background: #fff;
            margin-top: 30px;
            position: relative;
        }

        .conf-header {
            text-align: center;
            border-bottom: 2px dashed #cbd5e1;
            padding-bottom: 15px;
            margin-bottom: 15px;
        }

        .conf-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
            font-size: 15px;
        }

        .conf-val {
            font-weight: 700;
        }

        /* --- Special: Signature & Doc Preview --- */
        .doc-preview-area {
            background: #f8fafc;
            border: 1px solid var(--border);
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            font-size: 14px;
            line-height: 1.6;
            height: 300px;
            overflow-y: auto;
            box-shadow: inset 0 2px 4px 0 rgb(0 0 0 / 0.05);
        }

        canvas.sig-pad {
            border: 2px dashed var(--border);
            border-radius: 8px;
            width: 100%;
            height: 150px;
            background: #fff;
            touch-action: none;
        }

        /* --- Admin --- */
        .admin-panel {
            display: none;
            border-top: 2px dashed #94a3b8;
            margin-top: 40px;
            padding-top: 20px;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.6);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .data-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 13px;
            margin-top: 10px;
        }

        .data-table th,
        .data-table td {
            border: 1px solid var(--border);
            padding: 8px;
        }
    </style>
</head>

<body>

    <div class="container">
        <div class="header">
            <h1>è‚¡å‹™å°å¹«æ‰‹</h1>
            <div class="admin-trigger" onclick="openAdminLogin()"><i class="fas fa-cog"></i></div>
        </div>

        <!-- Tabs (Pill Style) -->
        <div class="tabs" id="main-tabs">
            <div class="tab active" onclick="switchTab('query')" id="tab-query">1. èº«ä»½é©—è­‰</div>
            <div class="tab" onclick="switchTab('netvalue')" id="tab-netvalue">2. æ¯æœˆæ·¨å€¼</div>
            <div class="tab" onclick="switchTab('calc')" id="tab-calc">3. è©¦ç®—å·¥å…·</div>
            <div class="tab" onclick="switchTab('subdocs')" id="tab-subdocs">4. å¢è³‡æ–‡ä»¶</div>
            <div class="tab" onclick="switchTab('docs')" id="tab-docs">5. è‚¡æ±æœƒ</div>
        </div>

        <!-- 1. Verify -->
        <div id="content-query" class="tab-content active">
            <div class="card" style="text-align:center; padding: 40px 20px;">
                <i class="fas fa-user-shield" style="font-size: 48px; color: var(--primary); margin-bottom: 20px;"></i>
                <div class="input-group" style="text-align:left;">
                    <label>é¸æ“‡è‚¡æ±å§“å</label>
                    <select id="userSelect">
                        <!-- JS Populated -->
                    </select>
                </div>
                <div class="input-group" style="text-align:left;">
                    <label>è¼¸å…¥é©—è­‰ç¢¼</label>
                    <input type="password" id="verifyCode" placeholder="6ä½æ•¸é©—è­‰ç¢¼">
                </div>
                <button class="btn" onclick="verify()">é©—è­‰èº«ä»½</button>
                <div id="errorMsg" style="color:var(--danger); margin-top:15px; display:none;">é©—è­‰å¤±æ•—</div>
            </div>
            <!-- Result State -->
            <div id="verifyResult" class="card"
                style="display:none; background:var(--primary-light); border-color:var(--primary);">
                <div style="display:flex; justify-content:space-between; align-items:center;">
                    <div>
                        <h3 style="margin:0; color:var(--primary);" id="resName">-</h3>
                        <div style="font-size:13px; color:var(--text-sub);" id="resId">-</div>
                    </div>
                    <div style="text-align:right;">
                        <div style="font-size:12px; color:var(--text-sub);">ç›®å‰æŒè‚¡</div>
                        <div style="font-size:24px; font-weight:800; color:var(--text-main);" id="resShares">-</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- 2. Net Value -->
        <div id="content-netvalue" class="tab-content">
            <div class="card">
                <canvas id="chartNetValue" height="220"></canvas>
            </div>
            <div class="card" style="padding:0; overflow:hidden;">
                <table class="data-table" style="margin:0; border:none;">
                    <tbody id="tableNetValue"></tbody>
                </table>
            </div>
        </div>

        <!-- 3. Calculator (Hybrid) -->
        <div id="content-calc" class="tab-content">

            <!-- Timeline Accordion -->
            <div class="timeline-box">
                <div class="timeline-header" onclick="toggleTimeline()">
                    <span><i class="fas fa-calendar-alt"></i> æ´»å‹•æ™‚ç¨‹è¡¨</span>
                    <i class="fas fa-chevron-down" id="timelineIcon"></i>
                </div>
                <div class="timeline-content" id="timelineContent">
                    <ul>
                        <li>3/28 è‚¡æ±æœƒé€šé2025æ‡‰ä»˜è‚¡åˆ©</li>
                        <li>5æœˆ èª¿æŸ¥7æœˆç¾é‡‘å¢è³‡æ„é¡˜</li>
                        <li>7/06 å…¬å¸ƒæ·¨å€¼èˆ‡å¢è³‡åƒ¹æ ¼</li>
                        <li>7/20 å¢è³‡æ”¶ä»¶æˆªæ­¢</li>
                        <li>8/17 è‚¡åˆ©åŒ¯æ¬¾æ—¥</li>
                    </ul>
                </div>
            </div>

            <!-- Logic Section -->
            <div class="card">
                <div class="conf-row"><span>æŒæœ‰è‚¡æ•¸</span><span class="conf-val" id="calBaseShares">0</span></div>
                <div class="conf-row"><span>èº«ä»½é¡åˆ¥</span><span class="conf-val" id="calBaseType">-</span></div>
                <hr style="margin:15px 0; border:0; border-top:1px solid var(--border);">

                <div class="conf-row">
                    <span>FY2025 è‚¡åˆ©ç¸½é¡ <small style="color:#64748b;">(@<span id="labelDiv">0</span>)</small></span>
                    <span class="conf-val" id="calTotalDiv">0</span>
                </div>
                <div class="conf-row">
                    <span>äºŒä»£å¥ä¿ <small id="labelTax" style="color:#64748b;">(0%)</small></span>
                    <span class="conf-val" style="color:var(--danger);" id="calTax">0</span>
                </div>
                <div class="conf-row" style="margin-top:10px; font-size:18px; color:var(--primary);">
                    <span>æ‡‰æ”¶è‚¡åˆ©æ·¨é¡</span>
                    <span class="conf-val" id="calNetDiv">0</span>
                </div>
            </div>

            <!-- Q&A Slider -->
            <div class="slider-row" style="margin-bottom:20px;">
                <span style="font-weight:600;">åƒèˆ‡æ­¤æ¬¡ç¾é‡‘å¢è³‡?</span>
                <label class="switch">
                    <input type="checkbox" id="toggleSub" onchange="onSubToggle()">
                    <span class="slider"></span>
                </label>
            </div>

            <div id="q2-area" class="card" style="display:none; animation:fadeIn 0.3s;">
                <div class="input-group">
                    <label>é è¨ˆèªè³¼è‚¡æ•¸ (æ¯è‚¡ <span id="labelSubPrice">0</span> å…ƒ)</label>
                    <input type="number" id="subShares" placeholder="è¼¸å…¥è‚¡æ•¸" oninput="calcFinal()">
                </div>
            </div>

            <!-- Confirmation Sheet (Auto Generated) -->
            <div id="final-result" style="display:none;">
                <div id="print-sheet" class="conf-sheet">
                    <div class="conf-header">
                        <h3 style="margin:0;">è©¦ç®—ç¢ºèªå–®</h3>
                        <small>åƒ…ä¾›è©¦ç®—ï¼Œå¯¦éš›é‡‘é¡ä»¥é€šçŸ¥ç‚ºæº–</small>
                    </div>
                    <!-- Content injected by JS -->
                    <div id="sheet-content"></div>

                    <div class="conf-row"
                        style="margin-top:20px; padding-top:15px; border-top:2px solid var(--text-main);">
                        <span style="font-size:18px;">æœ€çµ‚æ‡‰æ”¶ä»˜</span>
                        <span class="conf-val" style="font-size:24px;" id="sheet-total">0</span>
                    </div>
                    <div style="text-align:right; font-size:12px;" id="sheet-action">action</div>
                </div>
                <button class="btn outline" style="margin-top:15px;" onclick="downloadSheet()">
                    <i class="fas fa-download"></i> ä¸‹è¼‰ç¢ºèªå–®åœ–ç‰‡
                </button>
            </div>
        </div>

        <!-- 4. Sub Docs (Sign & PDF) -->
        <div id="content-subdocs" class="tab-content">
            <div class="card">
                <h3>å¢è³‡èªè³¼æ„é¡˜æ›¸</h3>
                <!-- Document Preview (Simplified HTML representation) -->
                <div class="doc-preview-area" id="docPreview">
                    <div style="text-align:center; font-weight:bold; margin-bottom:15px;">å¢è³‡èªè³¼æ„é¡˜æ›¸</div>
                    <p>ç«‹æ›¸äººï¼š<span id="docName">___</span> (æˆ¶è™Ÿ:<span id="docId">___</span>)</p>
                    <p>å…¹åŒæ„åƒèˆ‡æœ¬æ¬¡å¢è³‡ï¼Œä¸¦ç¢ºèªå³åˆ—è³‡è¨Šç„¡èª¤ã€‚</p>
                    <p>èªè³¼è‚¡æ•¸ï¼š<span id="docShares">0</span> è‚¡</p>
                    <p>ç¸½é‡‘é¡ï¼š<span id="docCost">0</span> å…ƒ</p>
                    <p>ç°½ç½²æ—¥æœŸï¼š<span id="docDate">202x/xx/xx</span></p>
                    <div id="docSigContainer" style="margin-top:20px; border-bottom:1px solid #000; height:50px;"></div>
                </div>

                <!-- Signature Pad -->
                <label style="font-size:14px; font-weight:600; display:block; margin-bottom:5px;">è«‹åœ¨æ­¤ç°½åï¼š</label>
                <canvas id="sigPad" class="sig-pad" width="300" height="150"></canvas>
                <div style="display:flex; gap:10px; margin-top:10px;">
                    <button class="btn outline" style="flex:1;" onclick="clearSig()">æ¸…é™¤</button>
                    <button class="btn" style="flex:2;" onclick="generatePDF()">ç¢ºèªç°½ç½²ä¸¦ä¸‹è¼‰ PDF</button>
                </div>
            </div>
        </div>

        <!-- 5. Meeting Docs -->
        <div id="content-docs" class="tab-content">
            <!-- Requested Attendance Button -->
            <div class="card" style="background:var(--primary-light); border-color:var(--primary); text-align:center;">
                <h3 style="margin-top:0; color:var(--primary);">å‡ºå¸­å ±åˆ°</h3>
                <p style="font-size:13px; color:var(--text-sub);">è‚¡æ±æœƒç•¶æ—¥è«‹é»æ“Šä¸‹æ–¹æŒ‰éˆ•é€²è¡Œå ±åˆ°</p>
                <button class="btn" onclick="alert('å ±åˆ°åŠŸèƒ½é–‹ç™¼ä¸­')">
                    <i class="fas fa-qrcode"></i> ç·šä¸Šå ±åˆ°
                </button>
            </div>

            <div class="card">
                <div class="conf-row" style="align-items:center;">
                    <div style="font-weight:600;">é›»å­æŠ•ç¥¨</div>
                    <button class="btn"
                        style="width:auto; padding:6px 12px; font-size:13px; background:var(--success);">å‰å¾€æŠ•ç¥¨</button>
                </div>
                <hr style="margin:10px 0; border:0; border-top:1px dashed var(--border);">
                <div class="conf-row" style="align-items:center;">
                    <div>é–‹æœƒé€šçŸ¥æ›¸</div>
                    <a href="#" style="color:var(--primary); font-size:13px;">ä¸‹è¼‰</a>
                </div>
                <div class="conf-row" style="align-items:center;">
                    <div>è­°äº‹æ‰‹å†Š</div>
                    <a href="#" style="color:var(--primary); font-size:13px;">ä¸‹è¼‰</a>
                </div>
            </div>
        </div>

        <!-- Admin Panel -->
        <div id="adminPanel" class="admin-panel">
            <h3>ğŸ”§ ç®¡ç†å¾Œå°</h3>
            <div style="display:flex; gap:5px; margin-bottom:15px;">
                <button onclick="admTab('users')" class="btn outline" style="width:auto; padding:5px 10px;">è‚¡æ±</button>
                <button onclick="admTab('params')" class="btn outline" style="width:auto; padding:5px 10px;">åƒæ•¸</button>
                <button onclick="admTab('data')" class="btn outline" style="width:auto; padding:5px 10px;">æ·¨å€¼</button>
                <button onclick="exportCode()" class="btn"
                    style="width:auto; padding:5px 10px; margin-left:auto; background:var(--success);">åŒ¯å‡º</button>
            </div>

            <div id="adm-users" class="adm-content">
                <div style="max-height:200px; overflow:auto;">
                    <table class="data-table" id="tblUsers">
                        <tbody></tbody>
                    </table>
                </div>
                <button class="btn outline" onclick="addUserRow()" style="margin-top:5px; font-size:12px;">+ æ–°å¢</button>
            </div>

            <div id="adm-params" class="adm-content" style="display:none;">
                <div class="input-group"><label>è‚¡åˆ© (å…ƒ)</label><input type="number" id="inpDiv" onchange="saveAdm()">
                </div>
                <div class="input-group"><label>å¢è³‡åƒ¹ (å…ƒ)</label><input type="number" id="inpSubPrice"
                        onchange="saveAdm()"></div>
            </div>

            <div id="adm-data" class="adm-content" style="display:none;">
                <table class="data-table" id="tblNet">
                    <tbody></tbody>
                </table>
                <button class="btn outline" onclick="addNetRow()" style="margin-top:5px; font-size:12px;">+ æ–°å¢</button>
            </div>
        </div>
    </div>

    <!-- Modals -->
    <div id="loginModal" class="modal">
        <div class="card" style="width:300px;">
            <h3>ç®¡ç†å“¡ç™»å…¥</h3>
            <input type="password" id="admPwd" placeholder="å¯†ç¢¼" style="margin-bottom:10px;">
            <button class="btn" onclick="admLogin()">ç™»å…¥</button>
            <button class="btn outline" style="margin-top:10px; border:none;"
                onclick="document.getElementById('loginModal').style.display='none'">å–æ¶ˆ</button>
        </div>
    </div>
    <div id="exportModal" class="modal">
        <div class="card" style="width:90%; max-width:400px;">
            <h3>åŒ¯å‡ºç¨‹å¼ç¢¼</h3>
            <textarea id="exportText" style="width:100%; height:150px; font-size:12px;" readonly></textarea>
            <button class="btn"
                onclick="navigator.clipboard.writeText(document.getElementById('exportText').value); alert('å·²è¤‡è£½')">è¤‡è£½</button>
            <button class="btn outline" style="margin-top:10px; border:none;"
                onclick="document.getElementById('exportModal').style.display='none'">é—œé–‰</button>
        </div>
    </div>

    <script>
        // --- Config & Data ---
        var CFG = { div: 1.5, subPrice: 15, tax: 2.11, thres: 20000 };
        var NET = [{ p: '2024/01', v: 12.5 }, { p: '2024/02', v: 12.8 }, { p: '2024/06', v: 14.2 }];
        var USERS = [
            { n: '01 è”¡**', id: '01', t: 'individual' },
            { n: '02 éƒ*******', id: '02', t: 'individual' },
            { n: '03 æ¥Š**', id: '03', t: 'individual' },
            { n: '04 å¼µ**', id: '04', t: 'individual' },
            { n: '05 æ¥Š**', id: '05', t: 'individual' },
            { n: '06 å´´*******', id: '06', t: 'individual' },
            { n: '08 æ¶‚**', id: '08', t: 'individual' },
            { n: '09 é‚±**', id: '09', t: 'individual' },
            { n: '10 æ—*', id: '10', t: 'individual' },
            { n: '12 èŒ—*****', id: '12', t: 'individual' },
            { n: '13 è”¡**', id: '13', t: 'individual' },
            { n: '14 ç‹**', id: '14', t: 'individual' },
            { n: '15 éƒ­**', id: '15', t: 'individual' },
            { n: '16 å»–**', id: '16', t: 'individual' },
            { n: '18 æ½˜**', id: '18', t: 'individual' },
            { n: '19 æ›¾**', id: '19', t: 'individual' },
            { n: '20 å±•***********', id: '20', t: 'individual' },
            { n: '21 æ¯”*******', id: '21', t: 'individual' },
            { n: '22 é™³**', id: '22', t: 'individual' },
            { n: '23 è•­**', id: '23', t: 'individual' },
            { n: '25 è¬**', id: '25', t: 'individual' },
            { n: '26 é‡‘********', id: '26', t: 'individual' },
            { n: '27 é™³**', id: '27', t: 'individual' },
            { n: '28 ç¦*******', id: '28', t: 'individual' },
            { n: '30 è³´**', id: '30', t: 'individual' },
            { n: '31 æ—**', id: '31', t: 'individual' },
            { n: '32 è¨±**', id: '32', t: 'individual' },
            { n: '33 æ­********', id: '33', t: 'individual' },
            { n: '34 é›¶*******', id: '34', t: 'individual' },
            { n: '35 é»˜********', id: '35', t: 'individual' },
            { n: '36 æ—**', id: '36', t: 'individual' },
            { n: '37 é‡‘*******', id: '37', t: 'individual' },
            { n: '38 è²*********', id: '38', t: 'individual' },
            { n: '39 èµ«*******', id: '39', t: 'individual' }
        ];
        const API = 'https://n8n-dbcapital-tool.chieh1025.workers.dev/';

        // --- State ---
        let ME = null;
        let chart = null;
        let sigPadCtx = null;
        let isDrawing = false;

        window.onload = () => {
            if (localStorage.CFG) CFG = JSON.parse(localStorage.CFG);
            if (localStorage.NET) NET = JSON.parse(localStorage.NET);
            if (localStorage.USERS) USERS = JSON.parse(localStorage.USERS);
            renderUI();
            initSigPad();
        };

        function renderUI() {
            // Dropdown
            const sel = document.getElementById('userSelect');
            sel.innerHTML = '<option value="">è«‹é¸æ“‡è‚¡æ±</option>';
            USERS.forEach(u => {
                let opt = document.createElement('option');
                opt.value = u.id; opt.innerText = u.n;
                sel.appendChild(opt);
            });

            // Params
            document.getElementById('inpDiv').value = CFG.div;
            document.getElementById('inpSubPrice').value = CFG.subPrice;
            document.getElementById('labelDiv').innerText = CFG.div;
            document.getElementById('labelSubPrice').innerText = CFG.subPrice;

            drawNet();
        }

        // --- 1. Verify ---
        async function verify() {
            const id = document.getElementById('userSelect').value;
            const pwd = document.getElementById('verifyCode').value;
            if (!id || !pwd) return alert('è«‹è¼¸å…¥å®Œæ•´è³‡æ–™');

            // â˜…â˜…â˜… æ¸¬è©¦æ¨¡å¼ Bypass â˜…â˜…â˜…
            if (pwd === '8888') {
                const local = USERS.find(u => u.id === id) || { n: 'æ¸¬è©¦äººå“¡', id: id, t: 'individual' };
                ME = { name: local.n, id: local.id, shares: 10000, type: local.t, success: true };

                document.getElementById('resName').innerText = ME.name;
                document.getElementById('resId').innerText = ME.id;
                document.getElementById('resShares').innerText = ME.shares.toLocaleString();
                document.getElementById('verifyResult').style.display = 'flex';
                document.getElementById('errorMsg').style.display = 'none';

                initCalc();
                updateDocPreview();
                alert('ã€æ¸¬è©¦æ¨¡å¼ã€‘é©—è­‰é€šé');
                return;
            }

            try {
                const r = await fetch(API, {
                    method: 'POST', headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ type: 'verify', shareholderId: id, verifyCode: pwd })
                });
                const d = await r.json();
                if (d.success) {
                    const local = USERS.find(u => u.id === id);
                    ME = { ...d, type: local ? local.t : 'individual' };

                    document.getElementById('resName').innerText = ME.name;
                    document.getElementById('resId').innerText = ME.id.substr(0, 3) + '****';
                    document.getElementById('resShares').innerText = ME.shares.toLocaleString();
                    document.getElementById('verifyResult').style.display = 'flex';
                    document.getElementById('errorMsg').style.display = 'none';

                    initCalc();
                    updateDocPreview(); // update doc info
                } else {
                    document.getElementById('errorMsg').style.display = 'block';
                }
            } catch (e) { alert('é€£ç·šå¤±æ•—'); }
        }

        // --- 3. Calculator ---
        function toggleTimeline() {
            const c = document.getElementById('timelineContent');
            const i = document.getElementById('timelineIcon');
            if (c.style.height === 'auto') {
                c.style.height = '0'; c.style.padding = '0 15px'; i.className = 'fas fa-chevron-down';
            } else {
                c.style.height = 'auto'; c.style.padding = '10px 15px'; i.className = 'fas fa-chevron-up';
            }
        }

        function initCalc() {
            if (!ME) return;
            document.getElementById('calBaseShares').innerText = ME.shares.toLocaleString();
            document.getElementById('calBaseType').innerText = ME.type == 'corporate' ? 'æ³•äºº' : 'è‡ªç„¶äºº';

            const total = Math.floor(ME.shares * CFG.div);
            document.getElementById('calTotalDiv').innerText = total.toLocaleString();

            let tax = 0;
            if (ME.type !== 'corporate' && total >= CFG.thres) {
                tax = Math.floor(total * (CFG.tax / 100));
                document.getElementById('labelTax').innerText = `(${CFG.tax}%)`;
            }
            document.getElementById('calTax').innerText = tax.toLocaleString();
            document.getElementById('calNetDiv').innerText = (total - tax).toLocaleString();

            calcFinal();
        }

        function onSubToggle() {
            const on = document.getElementById('toggleSub').checked;
            document.getElementById('q2-area').style.display = on ? 'block' : 'none';

            if (!on) {
                document.getElementById('subShares').value = 0;
                calcFinal();
            }
        }

        function calcFinal() {
            if (!ME) return;
            const netDiv = parseInt(document.getElementById('calNetDiv').innerText.replace(/,/g, '')) || 0;
            const subShares = parseInt(document.getElementById('subShares').value) || 0;
            const cost = subShares * CFG.subPrice;
            const final = netDiv - cost;

            // Render Sheet
            const html = `
            <div class="conf-row"><span>è‚¡æ±å§“å</span><span class="conf-val">${ME.name}</span></div>
            <div class="conf-row"><span>æ‡‰æ”¶è‚¡åˆ©</span><span class="conf-val">${netDiv.toLocaleString()}</span></div>
            <div class="conf-row"><span>èªè³¼è‚¡æ•¸</span><span class="conf-val">${subShares.toLocaleString()} è‚¡</span></div>
            <div class="conf-row"><span>æ‡‰ä»˜è‚¡æ¬¾</span><span class="conf-val" style="color:var(--danger)">-${cost.toLocaleString()}</span></div>
        `;
            document.getElementById('sheet-content').innerHTML = html;

            const totalEl = document.getElementById('sheet-total');
            const actEl = document.getElementById('sheet-action');

            if (final >= 0) {
                totalEl.innerText = `å¯¦é ˜ ${final.toLocaleString()}`;
                totalEl.style.color = 'var(--success)';
                actEl.innerText = 'å…¬å¸å°‡åŒ¯å…¥æ‚¨çš„å¸³æˆ¶';
            } else {
                totalEl.innerText = `è£œç¹³ ${Math.abs(final).toLocaleString()}`;
                totalEl.style.color = 'var(--danger)';
                actEl.innerText = 'è«‹ä¾é€šçŸ¥æ›¸åŒ¯æ¬¾';
            }

            document.getElementById('final-result').style.display = 'block';
        }

        function downloadSheet() {
            html2canvas(document.getElementById('print-sheet')).then(c => {
                const link = document.createElement('a');
                link.download = `ç¢ºèªå–®-${ME.name}.png`;
                link.href = c.toDataURL();
                link.click();
            });
        }

        // --- 4. Sub Docs (Signature) ---
        function updateDocPreview() {
            if (!ME) return;
            document.getElementById('docName').innerText = ME.name;
            document.getElementById('docId').innerText = ME.id;
            document.getElementById('docDate').innerText = new Date().toLocaleDateString();

            // update shares/cost from calc tab if possible, else 0
            const sub = document.getElementById('subShares').value || 0;
            document.getElementById('docShares').innerText = sub;
            document.getElementById('docCost').innerText = (sub * CFG.subPrice).toLocaleString();
        }

        function initSigPad() {
            const c = document.getElementById('sigPad');
            sigPadCtx = c.getContext('2d');
            sigPadCtx.lineWidth = 2;
            sigPadCtx.lineCap = 'round';

            const start = (e) => { isDrawing = true; sigPadCtx.beginPath(); draw(e); };
            const end = () => { isDrawing = false; sigPadCtx.beginPath(); };
            const draw = (e) => {
                if (!isDrawing) return;
                e.preventDefault();
                const rect = c.getBoundingClientRect();
                const x = (e.clientX || e.touches[0].clientX) - rect.left;
                const y = (e.clientY || e.touches[0].clientY) - rect.top;
                sigPadCtx.lineTo(x, y);
                sigPadCtx.stroke();
            };

            c.addEventListener('mousedown', start);
            c.addEventListener('mouseup', end);
            c.addEventListener('mousemove', draw);
            c.addEventListener('touchstart', start);
            c.addEventListener('touchend', end);
            c.addEventListener('touchmove', draw);
        }

        function clearSig() {
            const c = document.getElementById('sigPad');
            sigPadCtx.clearRect(0, 0, c.width, c.height);
            document.getElementById('docSigContainer').innerHTML = ''; // clear preview
        }

        function generatePDF() {
            if (!ME) return alert('è«‹å…ˆé©—è­‰');

            // 1. Snapshot Signature
            const sigCanvas = document.getElementById('sigPad');
            const sigImg = new Image();
            sigImg.src = sigCanvas.toDataURL();
            sigImg.style.height = '100%';

            // 2. Put in Preview
            const cont = document.getElementById('docSigContainer');
            cont.innerHTML = ''; cont.appendChild(sigImg);

            // 3. Generate PDF
            html2canvas(document.getElementById('docPreview')).then(c => {
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF();
                const imgData = c.toDataURL('image/png');
                const props = doc.getImageProperties(imgData);
                const pdfWidth = doc.internal.pageSize.getWidth();
                const pdfHeight = (props.height * pdfWidth) / props.width;

                doc.addImage(imgData, 'PNG', 0, 0, pdfWidth, pdfHeight);
                doc.save(`èªè³¼æ„é¡˜æ›¸-${ME.name}.pdf`);
            });
        }

        // --- Admin ---
        function openAdminLogin() { document.getElementById('loginModal').style.display = 'flex'; }
        async function admLogin() {
            const p = document.getElementById('admPwd').value;
            // Mock Verify for demo or REAL n8n
            if (p == 'admin') { // Bypass for easy manual testing or use n8n
                document.getElementById('loginModal').style.display = 'none';
                document.getElementById('adminPanel').style.display = 'block';
                renderAdm();
                return;
            }
            try {
                // Real n8n check
                const r = await fetch(API, { method: 'POST', body: JSON.stringify({ type: 'verify_admin', password: p }) });
                if ((await r.json()).success) {
                    document.getElementById('loginModal').style.display = 'none';
                    document.getElementById('adminPanel').style.display = 'block';
                    renderAdm();
                } else alert('Error');
            } catch (e) { alert('Error'); }
        }

        function admTab(t) {
            document.querySelectorAll('.adm-content').forEach(e => e.style.display = 'none');
            document.getElementById('adm-' + t).style.display = 'block';
        }

        function renderAdm() {
            const tb = document.querySelector('#tblUsers tbody');
            tb.innerHTML = '';
            USERS.forEach((u, i) => {
                tb.innerHTML += `<tr>
                <td><input value="${u.n}" onchange="USERS[${i}].n=this.value;saveAdm()"></td>
                <td><input value="${u.id}" onchange="USERS[${i}].id=this.value;saveAdm()"></td>
                <td><span onclick="USERS.splice(${i},1);saveAdm()" style="color:red; cursor:pointer;">x</span></td>
            </tr>`;
            });
        }

        function saveAdm() {
            CFG.div = parseFloat(document.getElementById('inpDiv').value);
            CFG.subPrice = parseFloat(document.getElementById('inpSubPrice').value);
            localStorage.CFG = JSON.stringify(CFG);
            localStorage.USERS = JSON.stringify(USERS);
            renderUI();
        }

        function exportCode() {
            const t = `var CFG = ${JSON.stringify(CFG)};\nvar USERS = ${JSON.stringify(USERS)};`;
            document.getElementById('exportText').value = t;
            document.getElementById('exportModal').style.display = 'flex';
        }

        // --- Tabs ---
        function switchTab(id) {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
            document.getElementById('tab-' + id).classList.add('active');
            document.getElementById('content-' + id).classList.add('active');
        }

        // Chart
        function drawNet() {
            const tbody = document.getElementById('tableNetValue');
            tbody.innerHTML = '';
            NET.forEach(n => tbody.innerHTML += `<tr><td>${n.p}</td><td>${n.v}</td></tr>`);

            const ctx = document.getElementById('chartNetValue').getContext('2d');
            if (chart) chart.destroy();
            chart = new Chart(ctx, {
                type: 'line',
                data: { labels: NET.map(n => n.p), datasets: [{ label: 'NAV', data: NET.map(n => n.v), borderColor: '#2563eb', tension: 0.3 }] }
            });
        }
    </script>
</body>

</html>
