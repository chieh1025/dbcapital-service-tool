<!DOCTYPE html>
<html lang="zh-TW">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>股務小幫手</title>
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

    <style>
        /* 列印專用樣式表 */
        @media print {
            .no-print {
                display: none !important;
            }

            body {
                background: white !important;
                padding: 0 !important;
            }

            .card {
                box-shadow: none !important;
                border: none !important;
                padding: 0 !important;
                margin: 0 !important;
                width: 100% !important;
                max-width: 100% !important;
            }

            .print-only {
                display: block !important;
            }

            .print-border {
                border: 2px solid #000 !important;
            }

            #print-section {
                position: absolute;
                top: 0;
                left: 0;
                width: 100%;
                padding: 20px;
            }

            /* 列印時強制字體大小調整，確保清晰 */
            .print-text-lg {
                font-size: 14pt !important;
            }

            .print-text-xl {
                font-size: 16pt !important;
            }

            .print-text-2xl {
                font-size: 20pt !important;
            }
        }

        .fade-in {
            animation: fadeIn 0.5s ease-in-out;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
            }

            to {
                opacity: 1;
            }
        }

        /* Accordion transition */
        .accordion-content {
            transition: max-height 0.3s ease-out, opacity 0.3s ease-out;
            max-height: 0;
            opacity: 0;
            overflow: hidden;
        }

        .accordion-content.expanded {
            max-height: 2000px;
            /* 足夠大的高度，避免長內容被截斷 */
            opacity: 1;
        }

        /* 簽名板樣式 */
        canvas.signature-pad {
            border: 2px dashed #cbd5e1;
            border-radius: 0.5rem;
            cursor: crosshair;
            background: #fff;
            width: 100%;
            touch-action: none;
            /* 防止手機滑動頁面 */
        }

        /* (已移除前端 DocumentPreview，改用 n8n HTML iframe 預覽) */
    </style>
</head>

<body class="bg-gray-100 text-slate-800 font-sans min-h-screen flex items-center justify-center py-4 sm:py-10">
    <div id="root" class="w-full max-w-5xl px-2 sm:px-4"></div>

    <script type="text/babel">
        const { useState, useMemo, useEffect, useRef } = React;

        // ==========================================
        // ★★★ DEFAULT CONFIG 設定預設值 ★★★
        // ==========================================
        const DEFAULT_CONFIG = {
            systemName: "股務小幫手",
            companyName: "達飆資本",

            // ★★★ n8n Webhook URL (使用 Cloudflare Worker) ★★★
            n8nApiUrl: 'https://n8n-dbcapital-tool.chieh1025.workers.dev/',

            forceFullOffset: true,

            tax: { rate: 0.0211, threshold: 20000 },

            // ★★★ 股份種類定義 (對應 n8n 回傳的 key) ★★★
            shareTypes: [
                { id: 'voting_shares', name: '普通股/甲種特別股' },
                { id: 'preferred_yi', name: '乙種特別股' }
            ],

            dividends: [
                { id: 'div1', label: '2025股利', amount: 54700 }
            ],

            subscriptionPrice: 160000,
            capitalIncreaseEnabled: 'true',
            docUploadEnabled: 'true',

            // ★★★ 股東戶號清單 (從 API 動態載入，這裡只是 fallback) ★★★
            shareholderOptions: [],

            // ★★★ 歷史淨值資料 ★★★
            // ★★★ 歷史淨值資料 ★★★
            netValueHistory: [
                { month: '2026/01', nav: 12.45, market_index: '23,450', note: '', events: '' },
                { month: '2025/12', nav: 12.30, market_index: '23,100', note: '年度結算', events: '股利發放' },
                { month: '2025/11', nav: 12.36, market_index: '22,900', note: '', events: '' },
                { month: '2025/10', nav: 12.15, market_index: '22,500', note: '', events: '' },
                { month: '2025/09', nav: 12.00, market_index: '22,000', note: '', events: '現金增資' }
            ],

            documents: [
                { id: "doc_offset", title: "1. 債權抵繳股款明細表", type: "paper_only", audience: "all", note: "需紙本簽核正本" },
                { id: "doc_invest", title: "2. 現金增資投資協議書", type: "hybrid", audience: "all", note: "" },
                { id: "doc_client", title: "3. 客戶聲明書", type: "hybrid", audience: "all", note: "" },
                { id: "doc_aml_nat", title: "4. 洗錢防制聲明書 (自然人)", type: "hybrid", audience: "natural", note: "" },
                { id: "doc_aml_leg", title: "5. 洗錢防制聲明書 (法人)", type: "hybrid", audience: "legal", note: "" },
                { id: "doc_beneficial", title: "6. 所有權人/實質受益人聲明書", type: "hybrid", audience: "legal", note: "" }
            ]
        };

        // --- 輔助函式 ---
        const formatMoney = (num) => new Intl.NumberFormat('zh-TW', { style: 'currency', currency: 'TWD', minimumFractionDigits: 0 }).format(num);
        const formatInput = (val) => {
            if (val === '' || val === undefined || val === null) return '';
            const str = val.toString();
            const parts = str.split('.');
            parts[0] = parts[0].replace(/\B(?=(\d{3})+(?!\d))/g, ",");
            return parts.join('.');
        };

        // ==========================================
        // ★★★ 簽名板元件 ★★★
        // ==========================================
        function SignatureCanvas({ onSave, onClear }) {
            const canvasRef = useRef(null);
            const [isDrawing, setIsDrawing] = useState(false);

            useEffect(() => {
                const canvas = canvasRef.current;
                if (!canvas) return;
                const ratio = Math.max(window.devicePixelRatio || 1, 1);
                canvas.width = canvas.offsetWidth * ratio;
                canvas.height = canvas.offsetHeight * ratio;
                canvas.getContext("2d").scale(ratio, ratio);
                const ctx = canvas.getContext('2d');
                ctx.strokeStyle = "#000";
                ctx.lineWidth = 2;
                ctx.lineCap = "round";
            }, []);

            const getPos = (e) => {
                const canvas = canvasRef.current;
                const rect = canvas.getBoundingClientRect();
                const x = (e.clientX || e.touches[0].clientX) - rect.left;
                const y = (e.clientY || e.touches[0].clientY) - rect.top;
                return { x, y };
            };

            const startDrawing = (e) => {
                e.preventDefault();
                setIsDrawing(true);
                const { x, y } = getPos(e);
                const ctx = canvasRef.current.getContext('2d');
                ctx.beginPath();
                ctx.moveTo(x, y);
            };

            const draw = (e) => {
                if (!isDrawing) return;
                e.preventDefault();
                const { x, y } = getPos(e);
                const ctx = canvasRef.current.getContext('2d');
                ctx.lineTo(x, y);
                ctx.stroke();
            };

            const stopDrawing = () => {
                if (isDrawing) {
                    setIsDrawing(false);
                    if (onSave) onSave(canvasRef.current.toDataURL());
                }
            };

            const clear = () => {
                const canvas = canvasRef.current;
                const ctx = canvas.getContext('2d');
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                ctx.beginPath();
                if (onClear) onClear();
            };

            return (
                <div className="relative">
                    <canvas
                        ref={canvasRef}
                        className="signature-pad h-48 w-full block"
                        onMouseDown={startDrawing}
                        onMouseMove={draw}
                        onMouseUp={stopDrawing}
                        onMouseLeave={stopDrawing}
                        onTouchStart={startDrawing}
                        onTouchMove={draw}
                        onTouchEnd={stopDrawing}
                    />
                    <button onClick={clear} className="absolute top-2 right-2 text-xs bg-gray-200 hover:bg-gray-300 px-2 py-1 rounded text-gray-600">
                        <i className="fas fa-eraser mr-1"></i>清除
                    </button>
                </div>
            );
        }


        function App() {
            // ★★★ 開發模式：?dev=1 自然人 | ?dev=2 法人 ★★★
            const isAdmin = new URLSearchParams(window.location.search).get('admin') === '1';

            // App Config State
            const [config, setConfig] = useState(DEFAULT_CONFIG);
            const [isConfigLoading, setIsConfigLoading] = useState(true);
            const [configError, setConfigError] = useState(null);
            const [activeTab, setActiveTab] = useState('identity'); // identity, net_value, calculation, capital_docs, meeting_docs

            // ★★★ 動態載入設定 ★★★
            useEffect(() => {
                const loadConfig = async () => {
                    try {
                        const response = await fetch(DEFAULT_CONFIG.n8nApiUrl, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ type: 'get_config' })
                        });
                        const data = await response.json();
                        if (data.success && data.config) {
                            setConfig(prev => ({
                                ...prev,
                                ...data.config,
                                // 保留本地設定不被覆蓋
                                n8nApiUrl: prev.n8nApiUrl,
                                shareTypes: prev.shareTypes,
                                tax: prev.tax,
                                documents: prev.documents,
                                // ?unlock=1 強制開啟所有開關
                                ...(isAdmin ? { capitalIncreaseEnabled: 'true', docUploadEnabled: 'true' } : {})
                            }));
                        } else {
                            setConfigError('無法載入設定');
                        }
                    } catch (e) {
                        console.error('Config load error:', e);
                        setConfigError('連線失敗: ' + e.message);
                    } finally {
                        setIsConfigLoading(false);
                    }
                };
                loadConfig();
            }, []);

            // ★★★ 輔助：判斷功能是否已截止 / 尚未開放 ★★★
            const isExpired = (deadline) => {
                if (!deadline) return false;
                return new Date() > new Date(deadline);
            };
            const isNotStarted = (startTime) => {
                if (!startTime) return false;
                return new Date() < new Date(startTime);
            };

            // ★★★ 取得 tab 狀態 ★★★
            const getTabStatus = (tabId) => {
                return config.tabConfig ? (config.tabConfig[tabId] || 'active') : 'active';
            };

            // --- 核心資料 for 股東 ---
            const [name, setName] = useState('');
            const [shareholderId, setShareholderId] = useState('');
            const [shareholderInfo, setShareholderInfo] = useState({
                idNumber: '', birthDate: '', nationality: '', address: '', phone: '', representative: '', docOffsetConfirmed: false, docStatuses: {}
            });

            // 驗證相關
            const [inputVerifyCode, setInputVerifyCode] = useState('');
            const [isVerified, setIsVerified] = useState(false);
            const [isVerifying, setIsVerifying] = useState(false);

            // 股份狀態
            const [sharesMap, setSharesMap] = useState(() => {
                const initial = {};
                config.shareTypes.forEach(t => initial[t.id] = '');
                return initial;
            });

            // 試算相關 State
            const [type, setType] = useState('natural');
            const [willingToOffset, setWillingToOffset] = useState(false);
            const [offsetShares, setOffsetShares] = useState('');
            const [additionalShares, setAdditionalShares] = useState('');
            const [isTimelineExpanded, setIsTimelineExpanded] = useState(false);

            // 出資來源勾選
            const [fundSources, setFundSources] = useState({});
            const toggleFundSource = (key) => setFundSources(prev => ({ ...prev, [key]: !prev[key] }));
            const hasFundSourcesSelected = () => Object.values(fundSources).some(v => v);
            const fundSourcesRef = React.useRef(fundSources);
            React.useEffect(() => {
                if (fundSourcesRef.current === fundSources) return; // 跳過初始化
                fundSourcesRef.current = fundSources;
                if (expandedDocId && (expandedDocId === 'doc_aml_nat' || expandedDocId === 'doc_aml_leg')) {
                    handlePreviewDoc(expandedDocId);
                }
            }, [fundSources]);

            // A3: 文件日期平移 — 若填寫日超出 config 設定的範圍，平移到最早/最晚日
            const getClampedDocDate = () => {
                const today = new Date().toISOString().slice(0, 10); // YYYY-MM-DD
                const earliest = config.docEarliestDate || '';
                const latest = config.docLatestDate || '';
                if (earliest && today < earliest) return earliest;
                if (latest && today > latest) return latest;
                return today;
            };

            // 產生文件結果
            const [docGenResults, setDocGenResults] = useState({}); // { doc_invest: { success, key, message }, ... }
            const [previewModalDocId, setPreviewModalDocId] = useState(null); // 手機版文件預覽 modal

            // ★★★ D3: 多張圖片合併上傳 ★★★
            const [pendingImages, setPendingImages] = useState({}); // { doc_id: [{ file, preview }] }

            // ★★★ B1: iframe 預覽 HTML 快取 ★★★
            const [previewHtmlMap, setPreviewHtmlMap] = useState({}); // { doc_id: htmlString }
            const [previewLoading, setPreviewLoading] = useState({}); // { doc_id: boolean }

            // 文件區狀態
            const [selectedDocId, setSelectedDocId] = useState('doc1'); // 對於 CapitalDocs 預設
            const [expandedDocId, setExpandedDocId] = useState(null);
            const [signMethod, setSignMethod] = useState('online');
            const [signatureImg, setSignatureImg] = useState(null);
            const [isProcessing, setIsProcessing] = useState(false);
            const [isCapturing, setIsCapturing] = useState(false);

            // Tab 4: 股東會功能狀態
            const [checkinStatus, setCheckinStatus] = useState(null); // null | 'online' | 'physical'
            const [votes, setVotes] = useState({}); // { proposal_id: 'agree'|'oppose'|'abstain' }
            const [isVoteSubmitted, setIsVoteSubmitted] = useState(false);
            const [isSubscriptionConfirmed, setIsSubscriptionConfirmed] = useState(false);
            const [viewingDoc, setViewingDoc] = useState(null); // null | doc id

            // --- Handlers ---
            const handleNumChange = (setter) => (e) => {
                const raw = e.target.value.replace(/,/g, '');
                if (raw === '' || !isNaN(raw)) setter(raw);
            };

            const handleShareTypeChange = (typeId) => (e) => {
                if (isVerified) return;
                const raw = e.target.value.replace(/,/g, '');
                if (raw === '' || !isNaN(raw)) {
                    setSharesMap(prev => ({ ...prev, [typeId]: raw }));
                }
            };

            const handleShareholderSelect = (e) => {
                const sid = e.target.value;
                setShareholderId(sid);
                setIsVerified(false);
                setInputVerifyCode('');
                setName('');
                const resetShares = {};
                config.shareTypes.forEach(t => resetShares[t.id] = '');
                setSharesMap(resetShares);

                // Reset calc
                setWillingToOffset(false);
                setOffsetShares('');
                setAdditionalShares('');
            };

            const handleVerifyIdentity = async () => {
                if (!shareholderId) return;
                if (!inputVerifyCode) {
                    alert("請輸入驗證碼");
                    return;
                }
                setIsVerifying(true);

                if (config.n8nApiUrl) {
                    try {
                        const response = await fetch(config.n8nApiUrl, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ type: 'verify', shareholderId: shareholderId, code: inputVerifyCode })
                        });

                        if (!response.ok) throw new Error(`Status: ${response.status}`);
                        const data = await response.json();

                        if (data.success) {
                            setIsVerified(true);
                            setName(data.name);
                            setShareholderInfo({
                                idNumber: data.idNumber || '',
                                birthDate: data.birthDate || '',
                                nationality: data.nationality || '',
                                address: data.address || '',
                                phone: data.phone || '',
                                representative: data.representative || '',
                                docOffsetConfirmed: data.docOffsetConfirmed === 'V',
                                docStatuses: data.docStatuses || {},
                                docFiles: data.docFiles || {}
                            });
                            if (data.shares) {
                                if (typeof data.shares === 'object') {
                                    setSharesMap(prev => ({ ...prev, ...data.shares }));
                                } else {
                                    const firstType = config.shareTypes[0].id;
                                    setSharesMap(prev => ({ ...prev, [firstType]: data.shares }));
                                }
                            }
                            // ★★★ Feature: Auto-Load Saved Subscription Data ★★★
                            if (data.willParticipate === '是') {
                                setWillingToOffset(true);
                                setAdditionalShares((data.subscriptionShares || 0).toString());
                                setIsSubscriptionConfirmed(true);
                            } else if (data.willParticipate === '否') {
                                setWillingToOffset(false);
                                setIsSubscriptionConfirmed(true);
                            }

                            alert(`驗證成功！歡迎 ${data.name} 股東。`);

                            // ★★★ Fix: Ensure type is set correctly based on local config or backend response ★★★
                            const localTarget = config.shareholderOptions.find(o => o.id === shareholderId);
                            if (data.type) {
                                setType(data.type);
                            } else if (localTarget) {
                                setType(localTarget.type || 'natural');
                            }
                        } else {
                            alert("驗證失敗：驗證碼錯誤或系統無此資料。");
                            setInputVerifyCode('');
                        }
                    } catch (e) {
                        console.error(e);
                        alert(`驗證連線失敗: ${e.message}`);
                    }
                } else {
                    await new Promise(r => setTimeout(r, 1000));
                    if (inputVerifyCode === '1196' || inputVerifyCode === '8888') {
                        setIsVerified(true);
                        // 嘗試從 shareTypes 中尋找設定，若無則預設
                        const target = config.shareholderOptions.find(o => o.id === shareholderId);
                        setName(target ? target.label.split(' ')[1] : "測試股東");
                        setType(target?.type || 'natural');

                        setSharesMap({ voting_shares: "2", preferred_yi: "0" });
                        alert("【測試模式】驗證成功！");
                    } else {
                        alert("【測試模式】驗證碼錯誤 (測試碼: 1196)");
                    }
                }
                setIsVerifying(false);
            };

            // Calculation Result Memo
            const result = useMemo(() => {
                let totalShares = 0;
                Object.values(sharesMap).forEach(val => { totalShares += (Number(val) || 0); });
                if (totalShares <= 0) return null;

                const dividendResults = config.dividends.map(setting => {
                    const gross = Math.floor(totalShares * setting.amount);
                    let hi = 0;
                    if (type === 'natural' && gross >= config.tax.threshold) hi = Math.floor(gross * config.tax.rate);
                    return { ...setting, gross, hi, net: gross - hi };
                });

                const totalNetDividend = dividendResults.reduce((sum, item) => sum + item.net, 0);
                let maxOffsetSharesPossible = 0;
                if (config.subscriptionPrice > 0) maxOffsetSharesPossible = Math.floor(totalNetDividend / config.subscriptionPrice);

                let extraShares = Number(additionalShares) || 0;
                let extraCost = extraShares * config.subscriptionPrice;

                let finalOffsetShares = 0;
                let finalOffsetCost = 0;

                // Auto-calculate offset if willing (Offset = Min(Dividend, Cost))
                // Note: The concept of "Offset Shares" is tricky if price > 1. 
                // Usually "Offset Amount" is the key. 
                // But if we strictly need "Offset Shares" (shares paid by dividend), it's floor(dividend / price).
                // However, here the requirement seems to be "Use dividend to pay for subscribed shares".

                if (willingToOffset) {
                    // The cost to be offset is the cost of the NEW shares (extraShares)
                    // Logic: How much of the dividend can be used?
                    // Max usable = totalNetDividend
                    // Needed = extraCost
                    finalOffsetCost = Math.min(totalNetDividend, extraCost);

                    // Reverse calculate shares if needed (though only cost matters for the doc)
                    // distinct from "Offset Shares" meaning "Shares bought purely by dividend"
                    // Here we just care about the amount.
                }

                const totalGrossDividend = dividendResults.reduce((sum, item) => sum + item.gross, 0);

                return {
                    totalShares, dividendResults, totalNetDividend, totalGrossDividend, maxOffsetSharesPossible,
                    finalOffsetShares, finalOffsetCost, extraShares, extraCost,
                    totalNewShares: extraShares, // All shares are now "extra/additional" since we removed the separate offset input
                    totalCost: extraCost,        // Total cost is just the cost of those shares
                    remainingDividendCash: totalNetDividend - finalOffsetCost,
                    finalBalance: (totalNetDividend - finalOffsetCost) - (extraCost - finalOffsetCost) // Simply: totalNetDividend - extraCost
                };
            }, [sharesMap, config.dividends, config.subscriptionPrice, config.tax, type, willingToOffset, offsetShares, additionalShares]);

            // Mobile Detection Hook (Simplified)
            const useIsMobile = () => {
                const [isMobile, setIsMobile] = useState(window.innerWidth < 768);
                useEffect(() => {
                    const handleResize = () => setIsMobile(window.innerWidth < 768);
                    window.addEventListener('resize', handleResize);
                    return () => window.removeEventListener('resize', handleResize);
                }, []);
                return isMobile;
            };

            const isMobile = useIsMobile();

            // ★★★ 呼叫後端 generate_doc API（Gotenberg → R2）★★★
            const handleGenerateDoc = async (docId, options = {}) => {
                if (!shareholderId || !config.n8nApiUrl) {
                    alert("請先選擇股東身分！");
                    return null;
                }
                setIsProcessing(true);
                try {
                    const totalHI = result?.dividendResults?.reduce((sum, d) => sum + d.hi, 0) || 0;
                    const body = {
                        type: 'generate_doc',
                        docId,
                        shareholderId,
                        shareholderName: name,
                        idNumber: shareholderInfo.idNumber,
                        representative: shareholderInfo.representative,
                        birthDate: shareholderInfo.birthDate,
                        nationality: shareholderInfo.nationality,
                        address: shareholderInfo.address,
                        phone: shareholderInfo.phone,
                        totalGrossDividend: result?.totalGrossDividend || 0,
                        healthInsuranceDeduction: totalHI,
                        extraCost: result?.extraCost || 0,
                        totalNewShares: result?.totalNewShares || 0,
                        totalCost: result?.totalCost || 0,
                        subscriptionPrice: config.subscriptionPrice || 160000,
                        fundSources: fundSources,
                        docDate: (docId === 'doc_offset' && config.docFixedDate) ? config.docFixedDate : getClampedDocDate(),
                        // 簽名圖（簽核版才帶）
                        ...(options.signatureImage ? { signatureImage: options.signatureImage } : {}),
                        // 標記是否為簽核版
                        ...(options.isSigned ? { isSigned: true } : {})
                    };

                    const res = await fetch(config.n8nApiUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(body)
                    });
                    const data = await res.json();

                    // 記錄結果
                    setDocGenResults(prev => ({ ...prev, [docId]: data }));

                    if (data.success) {
                        // 即時更新 docFiles 讓下載按鈕變色
                        if (data.key) {
                            setShareholderInfo(prev => ({ ...prev, docFiles: { ...prev.docFiles, [docId]: data.key } }));
                        }
                        return data;
                    } else {
                        alert('文件產生失敗：' + (data.error || data.message || '未知錯誤'));
                        return null;
                    }
                } catch (e) {
                    console.error('generate_doc error:', e);
                    alert('文件產生失敗：' + e.message);
                    return null;
                } finally {
                    setIsProcessing(false);
                }
            };

            // ★★★ B1: 預覽用 — 呼叫 Worker (skipPdf) 拿 n8n HTML ★★★
            const handlePreviewDoc = async (docId) => {
                if (!shareholderId || !config.n8nApiUrl) return;
                setPreviewLoading(prev => ({ ...prev, [docId]: true }));
                try {
                    const totalHI = result?.dividendResults?.reduce((sum, d) => sum + d.hi, 0) || 0;
                    const body = {
                        type: 'generate_doc',
                        skipPdf: true,
                        docId,
                        shareholderId,
                        shareholderName: name,
                        idNumber: shareholderInfo.idNumber,
                        representative: shareholderInfo.representative,
                        birthDate: shareholderInfo.birthDate,
                        nationality: shareholderInfo.nationality,
                        address: shareholderInfo.address,
                        phone: shareholderInfo.phone,
                        totalGrossDividend: result?.totalGrossDividend || 0,
                        healthInsuranceDeduction: totalHI,
                        extraCost: result?.extraCost || 0,
                        totalNewShares: result?.totalNewShares || 0,
                        totalCost: result?.totalCost || 0,
                        subscriptionPrice: config.subscriptionPrice || 160000,
                        fundSources: fundSources,
                        docDate: (docId === 'doc_offset' && config.docFixedDate) ? config.docFixedDate : getClampedDocDate()
                    };
                    const res = await fetch(config.n8nApiUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(body)
                    });
                    const data = await res.json();
                    if (data.success && data.html) {
                        setPreviewHtmlMap(prev => ({ ...prev, [docId]: data.html }));
                    } else {
                        console.error('Preview failed:', data);
                    }
                } catch (e) {
                    console.error('Preview error:', e);
                } finally {
                    setPreviewLoading(prev => ({ ...prev, [docId]: false }));
                }
            };

            // PDF/Image Handlers
            // ★★★ 改用 Gotenberg 後端產 PDF，不再用 html2canvas ★★★
            const handleGeneratePDF = async (action, targetDocId) => {
                if (!shareholderId) { alert("請先選擇股東身分！"); return; }
                if ((targetDocId === 'doc_aml_nat' || targetDocId === 'doc_aml_leg') && !hasFundSourcesSelected()) {
                    alert('請先勾選至少一項出資金額來源！');
                    return;
                }
                if (shareholderInfo.docStatuses[targetDocId] && !confirm('此文件已簽核過，確定要重新產生嗎？')) return;
                setIsProcessing(true);
                try {
                    // 1. 呼叫 generate_doc 產 PDF 並存到 R2
                    const data = await handleGenerateDoc(targetDocId);
                    if (!data || !data.success || !data.key) {
                        setIsProcessing(false);
                        return;
                    }

                    // 2. 從 R2 下載 PDF
                    const pdfUrl = config.n8nApiUrl.replace(/\/+$/, '').replace(/\/webhook\/api$/, '').replace(/n8n-dbcapital-service\.zeabur\.app.*/, 'n8n-dbcapital-tool.chieh1025.workers.dev') + '/' + data.key;
                    // 用 Worker URL 下載
                    const workerBase = 'https://n8n-dbcapital-tool.chieh1025.workers.dev/';
                    const downloadUrl = workerBase + data.key;

                    const docTitle = config.documents.find(d => d.id === targetDocId)?.title || targetDocId;
                    const filename = `${shareholderId}_${name}_${docTitle}.pdf`;

                    if (action === 'download') {
                        // 直接開啟下載連結
                        const res = await fetch(downloadUrl);
                        const blob = await res.blob();
                        const url = URL.createObjectURL(blob);
                        const a = document.createElement('a');
                        a.href = url;
                        a.download = filename;
                        a.click();
                        URL.revokeObjectURL(url);
                    } else if (action === 'share') {
                        const res = await fetch(downloadUrl);
                        const blob = await res.blob();
                        const file = new File([blob], filename, { type: 'application/pdf' });
                        if (navigator.canShare && navigator.canShare({ files: [file] })) {
                            try {
                                await navigator.share({ files: [file], title: docTitle, text: `${name} 的 ${docTitle}` });
                            } catch (err) {
                                console.error('Share failed:', err);
                                const url = URL.createObjectURL(blob);
                                const a = document.createElement('a');
                                a.href = url; a.download = filename; a.click();
                                URL.revokeObjectURL(url);
                            }
                        } else {
                            const url = URL.createObjectURL(blob);
                            const a = document.createElement('a');
                            a.href = url; a.download = filename; a.click();
                            URL.revokeObjectURL(url);
                        }
                    }
                } catch (err) { console.error(err); alert("文件生成失敗：" + err.message); }
                setIsProcessing(false);
            };

            // ★★★ 從 R2 下載已產生的文件 ★★★
            const handleDownloadExisting = async (docId) => {
                const fileKey = shareholderInfo.docFiles[docId];
                if (!fileKey) return;
                const workerBase = 'https://n8n-dbcapital-tool.chieh1025.workers.dev/';
                const downloadUrl = workerBase + encodeURIComponent(fileKey);
                const docTitle = config.documents.find(d => d.id === docId)?.title || docId;
                const filename = `${shareholderId}_${name}_${docTitle}.pdf`;
                try {
                    const res = await fetch(downloadUrl);
                    const blob = await res.blob();
                    if (isMobile && navigator.canShare) {
                        const file = new File([blob], filename, { type: 'application/pdf' });
                        if (navigator.canShare({ files: [file] })) {
                            try { await navigator.share({ files: [file], title: docTitle }); } catch (e) {}
                            return;
                        }
                    }
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url; a.download = filename; a.click();
                    URL.revokeObjectURL(url);
                } catch (e) { console.error('Download failed:', e); alert('下載失敗'); }
            };

            // ★★★ 法人上傳已用印文件 → R2（帶 _signed 後綴）★★★
            const docNameMap = {
                doc_offset: '1_債權抵繳股款明細表',
                doc_invest: '2_現金增資投資協議書',
                doc_client: '3_客戶聲明書',
                doc_aml_nat: '4_洗錢防制聲明書_自然人',
                doc_aml_leg: '5_洗錢防制聲明書_法人',
                doc_beneficial: '6_所有權人_實質受益人聲明書',
            };

            const uploadSignedFile = async (docId, base64, ext) => {
                const docLabel = docNameMap[docId] || docId;
                const now = new Date();
                const ts = now.getFullYear().toString()
                    + String(now.getMonth() + 1).padStart(2, '0')
                    + String(now.getDate()).padStart(2, '0') + '_'
                    + String(now.getHours()).padStart(2, '0')
                    + String(now.getMinutes()).padStart(2, '0')
                    + String(now.getSeconds()).padStart(2, '0');
                const safeKey = `${shareholderId}_${docLabel}_${ts}_signed${ext}`;
                const workerUrl = 'https://n8n-dbcapital-tool.chieh1025.workers.dev/';
                const res = await fetch(workerUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        type: 'upload_doc',
                        uploadSecret: 'dbcapital-upload-2025',
                        shareholderId,
                        docId,
                        filename: safeKey,
                        file: base64
                    })
                });
                return await res.json();
            };

            const handleFileUpload = async (e, docId) => {
                const files = Array.from(e.target.files);
                if (!files.length || !shareholderId) { alert("請先選擇股東身分！"); return; }
                if (shareholderInfo.docStatuses[docId] && !confirm('此文件已上傳過，確定要重新上傳嗎？')) { e.target.value = ''; return; }

                // 單一 PDF → 直接上傳
                if (files.length === 1 && files[0].name.endsWith('.pdf')) {
                    setIsProcessing(true);
                    try {
                        const base64 = await new Promise((resolve, reject) => {
                            const reader = new FileReader();
                            reader.onloadend = () => resolve(reader.result);
                            reader.onerror = reject;
                            reader.readAsDataURL(files[0]);
                        });
                        const data = await uploadSignedFile(docId, base64, '.pdf');
                        if (data.success) {
                            setDocGenResults(prev => ({ ...prev, [docId + '_signed']: { success: true, key: data.key } }));
                            if (data.key) setShareholderInfo(prev => ({ ...prev, docFiles: { ...prev.docFiles, [docId]: data.key } }));
                            alert('簽核版上傳成功！');
                        } else {
                            alert('上傳失敗：' + (data.message || '未知錯誤'));
                        }
                    } catch (err) {
                        console.error('Upload failed:', err);
                        alert('上傳失敗：' + err.message);
                    }
                    setIsProcessing(false);
                    e.target.value = '';
                    return;
                }

                // 圖片 → 暫存到 pendingImages，等合併上傳
                const newImages = [];
                for (const file of files) {
                    const preview = await new Promise((resolve, reject) => {
                        const reader = new FileReader();
                        reader.onloadend = () => resolve(reader.result);
                        reader.onerror = reject;
                        reader.readAsDataURL(file);
                    });
                    newImages.push({ file, preview });
                }
                setPendingImages(prev => ({
                    ...prev,
                    [docId]: [...(prev[docId] || []), ...newImages]
                }));
                e.target.value = '';
            };

            // ★★★ 多張圖片合併為 PDF 並上傳 ★★★
            const handleMergeUpload = async (docId) => {
                const images = pendingImages[docId];
                if (!images || !images.length) return;
                setIsProcessing(true);
                try {
                    const { jsPDF } = window.jspdf;
                    const pdf = new jsPDF();
                    for (let i = 0; i < images.length; i++) {
                        if (i > 0) pdf.addPage();
                        const img = new Image();
                        await new Promise((resolve, reject) => {
                            img.onload = resolve;
                            img.onerror = reject;
                            img.src = images[i].preview;
                        });
                        const pageW = pdf.internal.pageSize.getWidth();
                        const pageH = pdf.internal.pageSize.getHeight();
                        const ratio = Math.min(pageW / img.width, pageH / img.height);
                        const w = img.width * ratio;
                        const h = img.height * ratio;
                        const x = (pageW - w) / 2;
                        const y = (pageH - h) / 2;
                        pdf.addImage(images[i].preview, 'JPEG', x, y, w, h);
                    }
                    const pdfBase64 = 'data:application/pdf;base64,' + pdf.output('datauristring').split(',')[1];
                    const data = await uploadSignedFile(docId, pdfBase64, '.pdf');
                    if (data.success) {
                        setDocGenResults(prev => ({ ...prev, [docId + '_signed']: { success: true, key: data.key } }));
                        if (data.key) setShareholderInfo(prev => ({ ...prev, docFiles: { ...prev.docFiles, [docId]: data.key } }));
                        setPendingImages(prev => { const n = { ...prev }; delete n[docId]; return n; });
                        alert('已合併 ' + images.length + ' 張圖片為 PDF 並上傳成功！');
                    } else {
                        alert('上傳失敗：' + (data.message || '未知錯誤'));
                    }
                } catch (err) {
                    console.error('Merge upload failed:', err);
                    alert('合併上傳失敗：' + err.message);
                }
                setIsProcessing(false);
            };

            // ★★★ Feature: Auto-Save Subscription Data ★★★
            const handleSaveSubscription = async () => {
                if (!shareholderId || !result || !config.n8nApiUrl) return;
                setIsProcessing(true);
                try {
                    const totalHI = result.dividendResults.reduce((sum, d) => sum + d.hi, 0);
                    const res = await fetch(config.n8nApiUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            type: 'save_data',
                            shareholderId: shareholderId,
                            totalShares: result.totalShares,
                            totalGrossDividend: result.totalGrossDividend,
                            healthInsuranceDeduction: totalHI,
                            willParticipate: willingToOffset,
                            subscriptionShares: willingToOffset ? (Number(additionalShares) || 0) : 0,
                            subscriptionCost: willingToOffset ? result.extraCost : 0,
                            finalBalance: willingToOffset ? result.finalBalance : result.totalNetDividend
                        })
                    });
                    const data = await res.json();
                    if (data.success) {
                        setIsSubscriptionConfirmed(true);
                        const nth = data.submissionNumber ? `（第 ${data.submissionNumber} 次填寫）` : '';
                        if (willingToOffset) {
                            alert(`認購資料已儲存${nth}！正在生成文件上傳中...`);
                            setTimeout(() => uploadAllDocuments(), 500);
                        } else {
                            alert(`已記錄您不參與增資${nth}，預計將領回股利淨額。`);
                        }
                    } else {
                        alert('儲存失敗：' + (data.error || '未知錯誤'));
                    }
                } catch (e) {
                    console.error("Save failed", e);
                    alert('儲存失敗，請稍後再試');
                } finally {
                    setIsProcessing(false);
                }
            };

            // ★★★ 自動生成所有文件原檔（Gotenberg → R2）★★★
            const uploadAllDocuments = async () => {
                if (!result || !config.n8nApiUrl) return;
                const applicableDocs = config.documents.filter(doc => doc.audience === 'all' || doc.audience === type);
                let successCount = 0;
                let failCount = 0;

                for (const doc of applicableDocs) {
                    try {
                        const data = await handleGenerateDoc(doc.id);
                        if (data && data.success) {
                            successCount++;
                            console.log(`[產生成功] ${doc.title} → ${data.key}`);
                        } else {
                            failCount++;
                        }
                    } catch (e) {
                        console.error(`[產生失敗] ${doc.title}`, e);
                        failCount++;
                    }
                }
                alert(`文件原檔產生完成！成功 ${successCount} 份${failCount > 0 ? `，失敗 ${failCount} 份` : ''}`);
            };

            // ★★★ Tab 4: 報到 API ★★★
            const handleCheckin = async (mode) => {
                if (checkinStatus) return; // 已報到不可重複
                setIsProcessing(true);
                try {
                    const deviceInfo = {
                        timestamp: new Date().toISOString(),
                        userAgent: navigator.userAgent
                    };
                    try {
                        const ipRes = await fetch('https://api.ipify.org?format=json');
                        const ipData = await ipRes.json();
                        deviceInfo.ip = ipData.ip;
                    } catch (e) {
                        deviceInfo.ip = 'unknown';
                    }

                    const response = await fetch(config.n8nApiUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ type: 'checkin', shareholderId, mode, deviceInfo })
                    });
                    const data = await response.json();
                    if (data.success) {
                        setCheckinStatus(mode);
                        alert(`報到成功！方式：${mode === 'online' ? '線上出席' : '實體出席'}`);
                    } else {
                        alert('報到失敗：' + (data.message || '請稍後再試'));
                    }
                } catch (e) {
                    console.error('Checkin error:', e);
                    alert('報到連線失敗: ' + e.message);
                }
                setIsProcessing(false);
            };

            // ★★★ Tab 4: 投票 API ★★★
            const handleVoteSubmit = async () => {
                const proposals = config.proposals || [];
                // 檢查是否所有議案都已投票
                const allVoted = proposals.every(p => votes[p.id]);
                if (!allVoted) {
                    alert('請對所有議案完成投票後再送出');
                    return;
                }
                setIsProcessing(true);
                try {
                    const voteData = proposals.map(p => ({ id: p.id, choice: votes[p.id] }));
                    const deviceInfo = {
                        timestamp: new Date().toISOString(),
                        userAgent: navigator.userAgent
                    };
                    // 嘗試取得 IP
                    try {
                        const ipRes = await fetch('https://api.ipify.org?format=json');
                        const ipData = await ipRes.json();
                        deviceInfo.ip = ipData.ip;
                    } catch (e) {
                        deviceInfo.ip = 'unknown';
                    }

                    const response = await fetch(config.n8nApiUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ type: 'vote', shareholderId, votes: voteData, deviceInfo })
                    });
                    const data = await response.json();
                    if (data.success) {
                        setIsVoteSubmitted(true);
                        alert('投票送出成功！');
                    } else {
                        alert('投票失敗：' + (data.message || '請稍後再試'));
                    }
                } catch (e) {
                    console.error('Vote error:', e);
                    alert('投票連線失敗: ' + e.message);
                }
                setIsProcessing(false);
            };


            const handleDownloadImage = () => {
                const element = document.getElementById('print-section');
                if (!element) return;
                setIsCapturing(true);
                html2canvas(element, { scale: 2, backgroundColor: '#ffffff' }).then(canvas => {
                    if (isMobile && navigator.canShare) {
                        canvas.toBlob(async (blob) => {
                            const file = new File([blob], `股利增資金額確認書_${name}.png`, { type: 'image/png' });
                            if (navigator.canShare({ files: [file] })) {
                                try { await navigator.share({ files: [file], title: '股利增資金額確認書' }); } catch (e) {}
                            }
                            setIsCapturing(false);
                        });
                    } else {
                        const link = document.createElement('a');
                        link.href = canvas.toDataURL('image/png');
                        link.download = `股利增資金額確認書_${name}.png`;
                        document.body.appendChild(link);
                        link.click();
                        document.body.removeChild(link);
                        setIsCapturing(false);
                    }
                });
            };

            // --- TABS VISUAL ---
            const handleTabClick = (targetId) => {
                // 離開增資頁籤提醒
                if (activeTab === 'capital_increase' && targetId !== 'capital_increase' && result && !isSubscriptionConfirmed) {
                    if (!confirm('您尚未送出增資選項，確定要離開此頁嗎？')) return;
                }
                // 進入增資頁籤提示
                if (targetId === 'capital_increase' && isVerified && result) {
                    if (!isSubscriptionConfirmed) {
                        alert('提醒：您尚未送出增資選項，請在本頁選擇是否參與增資並按下送出按鈕。');
                    } else {
                        const shares = willingToOffset ? (Number(additionalShares) || 0) : 0;
                        const info = willingToOffset
                            ? `參與增資：是\n認購股數：${shares.toLocaleString()} 股\n${result.finalBalance >= 0 ? '應收股利：' + result.finalBalance.toLocaleString() : '需補繳股款：' + Math.abs(result.finalBalance).toLocaleString()}`
                            : `參與增資：否\n預計領回股利：${result.totalNetDividend.toLocaleString()}`;
                        alert('您的增資選項紀錄：\n\n' + info);
                    }
                }
                setActiveTab(targetId);
            };

            const MenuItem = ({ id, label, icon }) => {
                const status = getTabStatus(id);
                if (status === 'hidden') return null;
                return (
                    <button
                        onClick={() => handleTabClick(id)}
                        className={`flex-1 py-4 text-center font-bold text-sm md:text-base border-b-4 transition duration-200
                            ${activeTab === id ? 'border-blue-600 text-blue-600 bg-white' : 'border-transparent text-slate-400 hover:text-slate-600 hover:bg-slate-50'}`}
                    >
                        <div className="mb-1 text-xl"><i className={`fas ${icon}`}></i></div>
                        {label}
                        {status === 'construction' && <div className="text-xs text-orange-500 mt-1">建置中</div>}
                    </button>
                );
            };

            return (
                <div className="pb-20">
                    <header className="mb-4 sm:mb-6 flex justify-between items-center no-print pt-4 sm:pt-6 px-2 sm:px-4">
                        <h1 className="text-2xl sm:text-3xl font-extrabold text-slate-800 tracking-tight">{config.systemName}</h1>
                        {isVerified && (
                            <button onClick={() => { setIsVerified(false); setShareholderId(''); setName(''); setCheckinStatus(null); setVotes({}); setIsVoteSubmitted(false); setViewingDoc(null); setIsSubscriptionConfirmed(false); setActiveTab('identity'); }} className="text-sm text-slate-400 hover:text-red-500 transition flex items-center gap-1">
                                <i className="fas fa-sign-out-alt"></i><span className="hidden sm:inline">登出</span>
                            </button>
                        )}
                    </header>

                    <div className="bg-white shadow-xl rounded-xl border border-slate-200 card overflow-hidden min-h-[600px]">

                        {/* Navigation Tabs */}
                        <div className="flex border-b border-slate-200 bg-slate-50/50 no-print overflow-x-auto">
                            <MenuItem id="identity" label="1. 身份驗證" icon="fa-id-card" />
                            <MenuItem id="net_value" label="2. 每月淨值" icon="fa-chart-line" />
                            <MenuItem id="capital_increase" label="3. 增資文件" icon="fa-file-invoice-dollar" />
                            <MenuItem id="meeting_docs" label="4. 股東會文件" icon="fa-users" />
                        </div>

                        {/* --- TAB CONTENT --- */}

                        {/* Tab 1: Identity */}
                        {activeTab === 'identity' && (
                            <div className="p-4 sm:p-8 md:p-12 fade-in">
                                <h2 className="text-2xl font-bold mb-6 text-slate-700 border-l-4 border-blue-600 pl-4">股東身份驗證</h2>
                                <div className="max-w-md mx-auto space-y-8 py-8">
                                    {!isVerified ? (
                                        <div className="space-y-6 bg-slate-50 p-8 rounded-xl border border-slate-200 shadow-sm">
                                            <div>
                                                <label className="block text-sm font-bold text-slate-600 mb-2">選擇股東戶號</label>
                                                {isConfigLoading ? (
                                                    <div className="w-full p-4 border border-slate-300 rounded-lg bg-slate-100 text-slate-500 text-lg flex items-center justify-center">
                                                        <i className="fas fa-spinner fa-spin mr-2"></i>載入股東名單中...
                                                    </div>
                                                ) : configError ? (
                                                    <div className="w-full p-4 border border-red-300 rounded-lg bg-red-50 text-red-600 text-sm">
                                                        <i className="fas fa-exclamation-triangle mr-2"></i>{configError}
                                                    </div>
                                                ) : (
                                                    <select className="w-full p-4 border border-slate-300 rounded-lg bg-white text-lg focus:ring-2 focus:ring-blue-500 outline-none" value={shareholderId} onChange={handleShareholderSelect}>
                                                        <option value="">-- 請選擇 --</option>
                                                        {config.shareholderOptions.filter(opt => opt.id !== '合計').map(opt => (<option key={opt.id} value={opt.id}>{opt.label}</option>))}
                                                    </select>
                                                )}
                                            </div>
                                            {shareholderId && (
                                                <div className="fade-in">
                                                    <label className="block text-sm font-bold text-slate-600 mb-2">輸入驗證碼</label>
                                                    <input type="password" placeholder="****" className="w-full p-4 border border-slate-300 rounded-lg text-lg outline-none focus:ring-2 focus:ring-blue-500 mb-4" value={inputVerifyCode} onChange={(e) => setInputVerifyCode(e.target.value)} />
                                                    <button onClick={handleVerifyIdentity} disabled={isVerifying} className="w-full bg-blue-600 text-white py-4 rounded-lg font-bold text-lg hover:bg-blue-700 transition disabled:opacity-50">
                                                        {isVerifying ? '驗證中...' : '開始驗證'}
                                                    </button>
                                                </div>
                                            )}
                                        </div>
                                    ) : (
                                        <div className="bg-green-50 border border-green-200 p-8 rounded-xl text-center fade-in">
                                            <div className="w-20 h-20 bg-green-100 text-green-600 rounded-full flex items-center justify-center mx-auto mb-4 text-3xl">
                                                <i className="fas fa-check"></i>
                                            </div>
                                            <h3 className="text-2xl font-bold text-green-800 mb-1">{name}</h3>
                                            <div className="mb-4">
                                                <span className={`inline-block px-3 py-1 text-xs font-bold rounded-full ${type === 'legal' ? 'bg-purple-100 text-purple-700' : 'bg-blue-100 text-blue-700'}`}>
                                                    {type === 'legal' ? '法人股東' : '自然人股東'}
                                                </span>
                                            </div>
                                            <p className="text-green-600 mb-6">股東戶號: {shareholderId} | 驗證成功</p>

                                            <div className="grid grid-cols-2 gap-4 text-left bg-white p-4 rounded-lg border border-green-100 mb-6">
                                                {config.shareTypes.map(t => (
                                                    <div key={t.id}>
                                                        <div className="text-xs text-slate-500">{t.name}</div>
                                                        <div className="font-bold text-lg">{formatInput(sharesMap[t.id])} 股</div>
                                                    </div>
                                                ))}
                                            </div>

                                            <button onClick={() => handleTabClick('capital_increase')} className="w-full bg-blue-600 text-white py-3 rounded-lg font-bold hover:bg-blue-700 shadow-lg mb-3">
                                                前往增資計算機 <i className="fas fa-arrow-right ml-2"></i>
                                            </button>
                                            <button onClick={() => { setIsVerified(false); setShareholderId(''); setName(''); setCheckinStatus(null); setVotes({}); setIsVoteSubmitted(false); setViewingDoc(null); }} className="text-slate-400 hover:text-slate-600 underline text-sm">
                                                登出 / 重新驗證
                                            </button>
                                        </div>
                                    )}
                                </div>
                            </div>
                        )}

                        {/* Tab 2: Monthly Net Value */}
                        {activeTab === 'net_value' && (
                            <div className="p-4 sm:p-8 fade-in">
                                <h2 className="text-xl sm:text-2xl font-bold mb-6 text-slate-700 border-l-4 border-blue-600 pl-4">公司每月淨值公告</h2>
                                {getTabStatus('net_value') === 'construction' ? (
                                    <div className="flex flex-col items-center justify-center py-20">
                                        <div className="w-20 h-20 bg-orange-100 text-orange-400 rounded-full flex items-center justify-center mb-6 text-3xl"><i className="fas fa-hard-hat"></i></div>
                                        <h3 className="text-xl font-bold text-slate-600 mb-2">功能建置中</h3>
                                        <p className="text-slate-500">此功能尚在準備中，敬請期待。</p>
                                    </div>
                                ) : !isVerified ? (
                                    <div className="flex flex-col items-center justify-center py-20">
                                        <div className="w-20 h-20 bg-slate-100 text-slate-400 rounded-full flex items-center justify-center mb-6 text-3xl"><i className="fas fa-lock"></i></div>
                                        <h3 className="text-xl font-bold text-slate-600 mb-2">需要身份驗證</h3>
                                        <p className="text-slate-500 mb-6">請先至頁籤1完成身份驗證後，即可查看每月淨值資訊。</p>
                                        <button onClick={() => setActiveTab('identity')} className="bg-blue-600 text-white px-8 py-3 rounded-lg font-bold hover:bg-blue-700 transition shadow-md"><i className="fas fa-arrow-left mr-2"></i>前往身份驗證</button>
                                    </div>
                                ) : (
                                    <div>
                                        <div className="overflow-x-auto">
                                            <table className="w-full text-left border-collapse">
                                                <thead>
                                                    <tr className="bg-slate-100 text-slate-600">
                                                        <th className="p-2 sm:p-4 border-b">期間</th>
                                                        <th className="p-2 sm:p-4 border-b">每股淨值</th>
                                                        <th className="p-2 sm:p-4 border-b">月漲跌</th>
                                                    </tr>
                                                </thead>
                                                <tbody>
                                                    {config.netValueHistory.map((row, idx) => {
                                                        const prev = config.netValueHistory[idx + 1];
                                                        const monthlyChange = prev && prev.nav ? ((row.nav - prev.nav) / prev.nav * 100).toFixed(1) + '%' : '-';
                                                        const monthlyColor = monthlyChange.startsWith('-') ? 'text-green-600' : (monthlyChange === '-' ? 'text-slate-400' : 'text-red-600');
                                                        return (
                                                            <tr key={idx} className="hover:bg-slate-50">
                                                                <td className="p-2 sm:p-4 border-b">{row.month}</td>
                                                                <td className="p-2 sm:p-4 border-b font-mono font-bold text-slate-700">{typeof row.nav === 'number' ? row.nav.toLocaleString() : row.nav}</td>
                                                                <td className={`p-2 sm:p-4 border-b font-bold ${monthlyColor}`}>{monthlyChange}</td>
                                                            </tr>
                                                        );
                                                    })}
                                                </tbody>
                                            </table>
                                        </div>
                                        <p className="text-center text-slate-400 text-sm mt-8">資料更新時間: {new Date().toISOString().slice(0, 10)}</p>
                                    </div>
                                )}
                            </div>
                        )}

                        {/* Tab 3: Capital Increase Calculator */}
                        {activeTab === 'capital_increase' && (
                            <div className="fade-in">
                                <div className="p-4 sm:p-8 md:p-10">
                                    <h2 className="text-xl sm:text-2xl font-bold mb-4 sm:mb-6 text-slate-700 border-l-4 border-blue-600 pl-4">增資計算機</h2>
                                    {getTabStatus('capital_increase') === 'construction' ? (
                                        <div className="flex flex-col items-center justify-center py-20">
                                            <div className="w-20 h-20 bg-orange-100 text-orange-400 rounded-full flex items-center justify-center mb-6 text-3xl"><i className="fas fa-hard-hat"></i></div>
                                            <h3 className="text-xl font-bold text-slate-600 mb-2">功能建置中</h3>
                                            <p className="text-slate-500">此功能尚在準備中，敬請期待。</p>
                                        </div>
                                    ) : !isVerified ? (
                                        <div className="flex flex-col items-center justify-center py-20">
                                            <div className="w-20 h-20 bg-slate-100 text-slate-400 rounded-full flex items-center justify-center mb-6 text-3xl"><i className="fas fa-lock"></i></div>
                                            <h3 className="text-xl font-bold text-slate-600 mb-2">需要身份驗證</h3>
                                            <p className="text-slate-500 mb-6">請先至頁籤1完成身份驗證後，即可使用增資計算機。</p>
                                            <button onClick={() => setActiveTab('identity')} className="bg-blue-600 text-white px-8 py-3 rounded-lg font-bold hover:bg-blue-700 transition shadow-md"><i className="fas fa-arrow-left mr-2"></i>前往身份驗證</button>
                                        </div>
                                    ) : (
                                    <div>
                                    {/* Inputs */}
                                    <div className="grid grid-cols-1 md:grid-cols-2 gap-8 mb-8">
                                        <div className="bg-slate-50 p-6 rounded-xl border border-slate-200">
                                            <h4 className="font-bold text-slate-700 mb-4">持有股數</h4>
                                            <div className="space-y-4">
                                                {config.shareTypes.map(t => (
                                                    <div key={t.id}>
                                                        <label className="text-sm text-slate-500">{t.name}</label>
                                                        <input
                                                            type="text"
                                                            className={`w-full p-2 border rounded ${isVerified ? 'bg-slate-200' : 'bg-white'}`}
                                                            value={formatInput(sharesMap[t.id])}
                                                            onChange={handleShareTypeChange(t.id)}
                                                            readOnly={isVerified}
                                                            placeholder="0"
                                                        />
                                                    </div>
                                                ))}
                                                {result && <div className="text-right text-sm font-bold text-blue-600">總計: {formatInput(result.totalShares)} 股</div>}
                                            </div>
                                        </div>

                                        <div className="bg-slate-50 p-6 rounded-xl border border-slate-200 flex flex-col justify-center">
                                            {/* Identity Type Lock */}
                                            <div className="flex gap-4 mb-6">
                                                <label className={`flex-1 p-3 border rounded text-center cursor-pointer ${type === 'natural' ? 'bg-blue-100 border-blue-500 text-blue-700 font-bold' : (isVerified ? 'bg-gray-100 text-gray-400 cursor-not-allowed' : 'bg-white')}`}>
                                                    <input type="radio" checked={type === 'natural'} onChange={() => !isVerified && setType('natural')} disabled={isVerified} className="hidden" />自然人
                                                </label>
                                                <label className={`flex-1 p-3 border rounded text-center cursor-pointer ${type === 'legal' ? 'bg-purple-100 border-purple-500 text-purple-700 font-bold' : (isVerified ? 'bg-gray-100 text-gray-400 cursor-not-allowed' : 'bg-white')}`}>
                                                    <input type="radio" checked={type === 'legal'} onChange={() => !isVerified && setType('legal')} disabled={isVerified} className="hidden" />法人
                                                </label>
                                            </div>
                                            <div className="text-xs text-slate-500">
                                                * 自然人單筆股利超過 $20,000 需扣 {config.tax.rate * 100}% 二代健保; 法人免扣。
                                            </div>
                                        </div>
                                    </div>

                                    {/* Results Logic Flow */}
                                    {result && (
                                        <div className="fade-in space-y-8">
                                            {/* 1. Dividend Info */}
                                            <div className="bg-white border rounded-xl shadow-sm overflow-hidden">
                                                <div className="bg-slate-100 p-4 border-b flex justify-between items-center">
                                                    <h3 className="font-bold text-slate-700">1. 股利明細</h3>
                                                </div>
                                                <div className="p-6">
                                                    <div className="space-y-2 mb-4">
                                                        {result.dividendResults.map((div) => (
                                                            <div key={div.id} className="flex justify-between text-sm">
                                                                <span>{div.label}所得(${formatInput(div.amount)}*持有股數)</span>
                                                                <span className="font-mono text-slate-600">${formatInput(div.gross)}</span>
                                                            </div>
                                                        ))}
                                                        <hr className="border-dashed" />
                                                        <div className="flex justify-between text-sm text-slate-500">
                                                            <span>=股利總額</span>
                                                            <span>${formatInput(result.dividendResults.reduce((sum, d) => sum + d.gross, 0))}</span>
                                                        </div>
                                                        <div className="flex justify-between text-sm text-red-400">
                                                            <span>二代健保扣除額 ({type === 'natural' ? '2.11%' : '0%'})</span>
                                                            <span>-${formatInput(result.dividendResults.reduce((sum, d) => sum + d.hi, 0))}</span>
                                                        </div>
                                                    </div>
                                                    <div className="bg-blue-50 p-4 rounded-lg flex justify-between items-center text-blue-900">
                                                        <span className="font-bold">小計：股利淨額</span>
                                                        <span className="text-2xl font-bold">${formatInput(result.totalNetDividend)}</span>
                                                    </div>
                                                </div>
                                            </div>

                                            {/* 2. Action & Decision */}
                                            <div className="bg-white border-2 border-blue-100 rounded-xl shadow-md overflow-hidden relative">
                                                {config.capitalIncreaseEnabled !== 'true' && (
                                                    <div className="bg-amber-50 border-b border-amber-200 px-4 py-3 text-center">
                                                        <span className="text-amber-700 font-bold"><i className="fas fa-lock mr-2"></i>增資填寫已截止</span>
                                                    </div>
                                                )}
                                                <div className="p-6 text-center relative">
                                                    <button
                                                        onClick={() => { setWillingToOffset(false); setAdditionalShares(''); setOffsetShares(''); }}
                                                        className="absolute top-0 right-0 text-xs bg-slate-200 hover:bg-slate-300 text-slate-600 px-2 py-1 rounded disabled:opacity-30 disabled:cursor-not-allowed"
                                                        disabled={config.capitalIncreaseEnabled !== 'true'}
                                                    >
                                                        <i className="fas fa-undo mr-1"></i>重置
                                                    </button>
                                                    <h3 className="text-xl font-bold text-slate-700 mb-6">2. 是否參與本次增資？</h3>

                                                    <div className="inline-flex bg-slate-100 p-1 rounded-full mb-6">
                                                        <button
                                                            className={`px-8 py-3 rounded-full font-bold transition-all ${!willingToOffset ? 'bg-red-500 text-white shadow-lg' : 'text-slate-500 hover:bg-slate-200'} disabled:opacity-50 disabled:cursor-not-allowed`}
                                                            onClick={() => setWillingToOffset(false)}
                                                            disabled={config.capitalIncreaseEnabled !== 'true'}
                                                        >
                                                            否
                                                        </button>
                                                        <button
                                                            className={`px-8 py-3 rounded-full font-bold transition-all ${willingToOffset ? 'bg-green-500 text-white shadow-lg' : 'text-slate-500 hover:bg-slate-200'} disabled:opacity-50 disabled:cursor-not-allowed`}
                                                            onClick={() => { setWillingToOffset(true); setAdditionalShares(''); }}
                                                            disabled={config.capitalIncreaseEnabled !== 'true'}
                                                        >
                                                            是
                                                        </button>
                                                    </div>

                                                    {/* Branching Logic */}
                                                    {!willingToOffset ? (
                                                        <div className="mt-4 p-6 bg-red-50 rounded-xl border border-red-100 fade-in">
                                                            <div className="text-slate-600 mb-2">您選擇 <span className="font-bold text-red-600">不參與</span> 增資</div>
                                                            <div className="text-sm text-slate-500 mb-4">預計將領回全額股利現金</div>
                                                            <div className="text-3xl font-bold text-red-600">
                                                                實際應收付金額： <span className="text-green-600">+${formatInput(result.totalNetDividend)}</span> (領回)
                                                            </div>
                                                            <button onClick={handleSaveSubscription} disabled={isProcessing || config.capitalIncreaseEnabled !== 'true'} className="mt-6 w-full bg-red-600 text-white py-3 rounded-lg font-bold hover:bg-red-700 shadow-md disabled:opacity-50 transition">
                                                                {isProcessing ? <><i className="fas fa-spinner fa-spin mr-2"></i>儲存中...</> : <><i className="fas fa-check mr-2"></i>確認不參與增資</>}
                                                            </button>
                                                        </div>
                                                    ) : (
                                                        <div className="mt-4 text-left fade-in">
                                                            <div className="mb-6">
                                                                <label className="block font-bold text-slate-700 mb-2">請輸入欲認購股數 (增資價格 ${formatInput(config.subscriptionPrice)}/股)</label>
                                                                <input
                                                                    type="text"
                                                                    className="w-full text-2xl p-4 border-2 border-blue-500 rounded-lg text-center font-bold text-blue-700 outline-none disabled:bg-slate-100 disabled:text-slate-400"
                                                                    value={formatInput(additionalShares)}
                                                                    onChange={handleNumChange(setAdditionalShares)}
                                                                    placeholder="請輸入股數"
                                                                    disabled={config.capitalIncreaseEnabled !== 'true'}
                                                                />
                                                            </div>

                                                            <div className="bg-slate-50 p-4 rounded-lg space-y-3 text-sm border border-slate-200 mb-6">
                                                                <div className="flex justify-between">
                                                                    <span>認購總價金 ({formatInput(Number(additionalShares) || 0)} 股 x ${formatInput(config.subscriptionPrice)})</span>
                                                                    <span className="font-mono">${formatInput(result.extraCost)}</span>
                                                                </div>
                                                                <div className="flex justify-between text-green-600">
                                                                    <span>股利抵繳金額 (上限 ${formatInput(result.totalNetDividend)})</span>
                                                                    <span>-${formatInput(Math.min(result.extraCost, result.totalNetDividend))}</span>
                                                                </div>
                                                            </div>

                                                            <div className="p-4 sm:p-6 bg-blue-50 rounded-xl border border-blue-100 text-center">
                                                                <div className="text-slate-600 mb-2">計算結果</div>
                                                                <div className="text-xl sm:text-3xl font-bold text-blue-800">
                                                                    {result.extraCost > result.totalNetDividend ? (
                                                                        <span>實際應補繳金額： <span className="text-red-500">${formatInput(result.extraCost - result.totalNetDividend)}</span></span>
                                                                    ) : (
                                                                        <span>實際應退回金額： <span className="text-green-600">+${formatInput(result.totalNetDividend - result.extraCost)}</span> (領回)</span>
                                                                    )}
                                                                </div>
                                                                <button onClick={handleSaveSubscription} disabled={isProcessing || !additionalShares || config.capitalIncreaseEnabled !== 'true'} className="mt-6 w-full bg-blue-600 text-white py-3 rounded-lg font-bold hover:bg-blue-700 shadow-md disabled:opacity-50 transition">
                                                                    {isProcessing ? <><i className="fas fa-spinner fa-spin mr-2"></i>儲存中...</> : <><i className="fas fa-paper-plane mr-2"></i>確認認購送出</>}
                                                                </button>
                                                            </div>
                                                        </div>
                                                    )}
                                                </div>
                                            </div>

                                            {/* Preview Card */}
                                            {result && (
                                                <div>
                                                    <div id="print-section" className="mt-10 p-4" style={{ backgroundColor: '#f8fafc' }}>
                                                    <div className="bg-white border-4 border-slate-800 rounded-xl p-4 sm:p-8 text-base sm:text-xl font-medium text-slate-900 shadow-lg">
                                                        <div className="text-center mb-4 sm:mb-8">
                                                            <h3 className="text-2xl sm:text-4xl font-extrabold mb-2 sm:mb-3 tracking-wide">{config.companyName}</h3>
                                                            <div className="inline-block border-b-4 border-slate-800 pb-2 mb-2">
                                                                <h4 className="text-xl sm:text-3xl font-bold">股利增資金額確認書</h4>
                                                            </div>
                                                        </div>
                                                        <div className="space-y-4 sm:space-y-6">
                                                            <div className="flex flex-col sm:flex-row justify-between sm:items-end border-b-2 border-slate-200 pb-4 gap-1">
                                                                <div className="text-lg sm:text-2xl">姓名：<span className="font-bold">{name}</span></div>
                                                                <div className="text-base sm:text-xl text-slate-600">總持有：<span className="font-bold text-slate-900">{formatInput(result.totalShares)}</span> 股</div>
                                                            </div>

                                                            <div className="space-y-4">
                                                                {/* 1. Gross Dividend */}
                                                                <div className="flex justify-between items-center bg-slate-50 p-3 sm:p-4 rounded-lg">
                                                                    <span className="text-sm sm:text-xl font-bold text-slate-700">1. 股利總額</span>
                                                                    <span className="text-lg sm:text-2xl font-bold text-blue-700 font-mono tracking-tight">${formatInput(result.dividendResults.reduce((sum, d) => sum + d.gross, 0))}</span>
                                                                </div>

                                                                {/* 2. NHI Deduction */}
                                                                <div className="flex justify-between items-center bg-slate-50 p-3 sm:p-4 rounded-lg">
                                                                    <span className="text-sm sm:text-xl font-bold text-slate-700">2. 二代健保扣除數</span>
                                                                    <span className="text-lg sm:text-2xl font-bold text-red-500 font-mono tracking-tight">-${formatInput(result.dividendResults.reduce((sum, d) => sum + d.hi, 0))}</span>
                                                                </div>

                                                                {/* 3. Subscription Deduction */}
                                                                <div className="flex justify-between items-center bg-slate-50 p-3 sm:p-4 rounded-lg">
                                                                    <span className="text-sm sm:text-xl font-bold text-slate-700">3. 認購新股扣除數 <span className="text-xs sm:text-base font-normal text-slate-500">({formatInput(result.totalNewShares)}股)</span></span>
                                                                    <span className="text-lg sm:text-2xl font-bold text-red-500 font-mono tracking-tight">-${formatInput(result.totalCost)}</span>
                                                                </div>
                                                            </div>

                                                            <div className="border-t-4 border-slate-800 pt-4 sm:pt-6 mt-4 sm:mt-6">
                                                                <div className="flex justify-between items-center">
                                                                    <span className="text-xl sm:text-3xl font-extrabold text-slate-900">應收付淨額</span>
                                                                    <div className="text-right">
                                                                        <div className={`text-2xl sm:text-5xl font-extrabold font-mono ${result.finalBalance >= 0 ? 'text-blue-600' : 'text-red-600'}`}>
                                                                            ${formatInput(result.finalBalance)}
                                                                        </div>
                                                                        <div className="text-xs sm:text-sm text-slate-400 mt-1 sm:mt-2 font-bold">
                                                                            {result.finalBalance >= 0 ? '(公司應付股東款項)' : '(股東應補繳款項)'}
                                                                        </div>
                                                                    </div>
                                                                </div>
                                                            </div>
                                                            <div className="text-center mt-6 sm:mt-8 pt-4 border-t border-slate-200">
                                                                <span className="text-lg sm:text-2xl font-bold text-slate-400">日期: {new Date().toLocaleDateString()}</span>
                                                            </div>
                                                        </div>
                                                    </div>
                                                    </div>

                                                    <div className="flex justify-center gap-3 sm:gap-4 mt-6 sm:mt-8 no-print">
                                                        <button onClick={handleDownloadImage} disabled={isCapturing} className="bg-slate-700 text-white px-4 sm:px-8 py-3 rounded-lg font-bold hover:bg-slate-800 shadow-md transform transition active:scale-95 flex items-center justify-center whitespace-nowrap flex-1 sm:flex-none sm:min-w-[150px]">
                                                            {isMobile ? <><i className="fas fa-share-alt mr-2"></i>儲存 / 分享</> : <><i className="fas fa-download mr-2"></i>下載圖片</>}
                                                        </button>
                                                    </div>
                                                </div>
                                            )}

                                            {/* Integrated Documents Section (ALL Docs 1-6) - Only if Willing to Offset */}
                                            {willingToOffset && result && (
                                                <div id="capital-docs-section" className="mt-8 pt-8 border-t border-blue-200 fade-in no-print">
                                                    <div className="text-center mb-6">
                                                        <h3 className="font-bold text-2xl text-slate-800 flex justify-center items-center"><i className="fas fa-file-signature text-blue-600 mr-3"></i>增資認購文件</h3>
                                                        {config.docUploadEnabled !== 'true' ? (
                                                            <div className="mt-3 bg-amber-50 border border-amber-200 rounded-lg px-4 py-2 inline-block">
                                                                <span className="text-amber-700 font-bold text-sm"><i className="fas fa-lock mr-2"></i>文件上傳已截止，僅供查閱下載</span>
                                                            </div>
                                                        ) : (
                                                            <p className="text-slate-500 mt-2 text-sm">請依序完成以下文件簽署</p>
                                                        )}
                                                    </div>

                                                    {/* Document List */}
                                                    <div className="space-y-4">
                                                        {config.documents.filter(doc => doc.audience === 'all' || doc.audience === type).map(doc => {
                                                            const isExpanded = expandedDocId === doc.id;
                                                            const isPaperOnly = doc.type === 'paper_only';
                                                            const isHybrid = doc.type === 'hybrid';
                                                            const isAmlDoc = doc.id === 'doc_aml_nat' || doc.id === 'doc_aml_leg';

                                                            const handleExpand = () => {
                                                                if (isExpanded) {
                                                                    setExpandedDocId(null);
                                                                } else {
                                                                    setExpandedDocId(doc.id);
                                                                    setSignatureImg(null);
                                                                    if (type === 'natural' && isHybrid) {
                                                                        setSignMethod('online');
                                                                    } else {
                                                                        setSignMethod('paper');
                                                                    }
                                                                    // ★ B1: 展開時自動載入預覽
                                                                    if (!previewHtmlMap[doc.id]) {
                                                                        handlePreviewDoc(doc.id);
                                                                    }
                                                                }
                                                            };

                                                            return (
                                                                <div key={doc.id} className={`border rounded-xl overflow-hidden transition-all ${isExpanded ? 'border-blue-500 shadow-lg' : 'border-slate-200 bg-white hover:border-blue-300'}`}>
                                                                    <div onClick={handleExpand} className={`p-6 cursor-pointer flex justify-between items-center ${isExpanded ? 'bg-blue-50' : 'bg-white'}`}>
                                                                        <div className="flex items-center gap-4">
                                                                            <div className={`w-10 h-10 rounded-full flex items-center justify-center ${isExpanded ? 'bg-blue-600 text-white' : 'bg-slate-100 text-slate-400'}`}>
                                                                                <i className={`fas ${doc.id.includes('offset') || doc.id.includes('invest') ? 'fa-file-invoice-dollar' : 'fa-file-contract'}`}></i>
                                                                            </div>
                                                                            <div>
                                                                                <h3 className={`font-bold text-lg ${isExpanded ? 'text-blue-800' : 'text-slate-700'}`}>{doc.title}</h3>
                                                                                <p className="text-xs text-slate-500">{doc.note}</p>
                                                                            </div>
                                                                        </div>
                                                                        <div className="flex items-center gap-3">
                                                                            {shareholderInfo.docStatuses[doc.id] && (
                                                                                <span className="text-xs bg-green-100 text-green-700 px-2 py-1 rounded-full font-bold whitespace-nowrap">
                                                                                    <i className="fas fa-check-circle mr-1"></i>已繳交 {shareholderInfo.docStatuses[doc.id]}
                                                                                </span>
                                                                            )}
                                                                            {doc.id === 'doc_offset' && shareholderInfo.docOffsetConfirmed && (
                                                                                <span className="text-xs bg-blue-100 text-blue-700 px-2 py-1 rounded-full font-bold whitespace-nowrap">
                                                                                    <i className="fas fa-stamp mr-1"></i>股務已確認
                                                                                </span>
                                                                            )}
                                                                            <i className={`fas fa-chevron-down transition-transform ${isExpanded ? 'rotate-180 text-blue-600' : 'text-slate-300'}`}></i>
                                                                        </div>
                                                                    </div>

                                                                    <div className={`accordion-content ${isExpanded ? 'expanded' : ''} bg-slate-50`}>
                                                                        <div className="p-4 sm:p-6 border-t border-blue-100">
                                                                            {/* ★ 下載上次已產生的文件 */}
                                                                            <button onClick={() => handleDownloadExisting(doc.id)} disabled={!shareholderInfo.docFiles[doc.id]} className={`w-full mb-4 py-3 rounded-lg font-bold transition flex items-center justify-center gap-2 ${shareholderInfo.docFiles[doc.id] ? 'bg-green-50 border border-green-300 text-green-700 hover:bg-green-100' : 'bg-slate-100 border border-slate-200 text-slate-300 cursor-not-allowed'}`}>
                                                                                <i className="fas fa-file-download"></i><span>下載上次文件</span>
                                                                            </button>
                                                                            {/* ★ 手機版：預覽按鈕 + 全螢幕 Modal */}
                                                                            {isMobile && (
                                                                                <button onClick={() => { if (!previewHtmlMap[doc.id]) handlePreviewDoc(doc.id); setPreviewModalDocId(doc.id); }} className="w-full mb-4 border border-blue-300 text-blue-700 py-3 rounded-lg font-bold hover:bg-blue-50 transition flex items-center justify-center gap-2">
                                                                                    <i className="fas fa-eye"></i><span>預覽文件內容</span>
                                                                                </button>
                                                                            )}
                                                                            <div className="flex flex-col lg:flex-row gap-4 lg:gap-8">
                                                                                {/* ★★★ B1: 桌面版 iframe 預覽（取代 DocumentPreview） ★★★ */}
                                                                                {!isMobile && (
                                                                                <div className="lg:w-2/3 bg-white rounded shadow-inner overflow-hidden border border-slate-200" style={{ minHeight: '500px' }}>
                                                                                    {previewLoading[doc.id] ? (
                                                                                        <div className="flex items-center justify-center h-full py-20">
                                                                                            <i className="fas fa-spinner fa-spin text-3xl text-blue-400 mr-3"></i>
                                                                                            <span className="text-slate-500">載入預覽中...</span>
                                                                                        </div>
                                                                                    ) : previewHtmlMap[doc.id] ? (
                                                                                        <iframe
                                                                                            srcDoc={previewHtmlMap[doc.id]}
                                                                                            className="w-full border-0"
                                                                                            style={{ height: '80vh' }}
                                                                                            title={doc.title}
                                                                                            sandbox="allow-same-origin"
                                                                                        />
                                                                                    ) : (
                                                                                        <div className="flex items-center justify-center h-full py-20">
                                                                                            <button onClick={() => handlePreviewDoc(doc.id)} className="bg-blue-100 text-blue-700 px-6 py-3 rounded-lg font-bold hover:bg-blue-200 transition">
                                                                                                <i className="fas fa-eye mr-2"></i>載入預覽
                                                                                            </button>
                                                                                        </div>
                                                                                    )}
                                                                                </div>
                                                                                )}

                                                                                {/* Action Panel */}
                                                                                <div className={`${isMobile ? 'w-full' : 'lg:w-1/3'} space-y-4 sm:space-y-6`}>
                                                                                    {config.docUploadEnabled !== 'true' && (
                                                                                    <div className="bg-amber-50 border border-amber-200 rounded-lg p-3 text-center">
                                                                                        <span className="text-amber-600 text-sm font-bold"><i className="fas fa-lock mr-1"></i>文件上傳已截止，僅供查閱下載</span>
                                                                                    </div>
                                                                                )}
                                                                                {config.docUploadEnabled === 'true' && <>
                                                                                {/* ★★★ 出資來源勾選（洗錢防制聲明書才顯示） ★★★ */}
                                                                                    {isAmlDoc && (
                                                                                        <div className={`bg-white p-4 rounded-xl shadow-sm border ${hasFundSourcesSelected() ? 'border-slate-200' : 'border-red-400 ring-1 ring-red-300'}`}>
                                                                                            <h4 className="font-bold mb-3 text-slate-700 text-sm"><i className="fas fa-wallet mr-1"></i>出資金額來源{!hasFundSourcesSelected() && <span className="text-red-500 ml-1">(必選)</span>}</h4>
                                                                                            <div className="flex flex-wrap gap-2">
                                                                                                {(type === 'legal' ? ['資本','薪資','營利','借款','受贈','繼承'] : ['薪資','營利','借款','受贈','繼承']).map(src => (
                                                                                                    <button key={src} onClick={() => toggleFundSource(src)} className={`px-3 py-1.5 rounded-lg border text-sm font-bold transition ${fundSources[src] ? 'bg-blue-100 border-blue-500 text-blue-700' : 'border-slate-200 text-slate-500 hover:bg-slate-50'}`}>
                                                                                                        {fundSources[src] && <i className="fas fa-check mr-1 text-xs"></i>}{src}
                                                                                                    </button>
                                                                                                ))}
                                                                                                <button onClick={() => toggleFundSource('其他')} className={`px-3 py-1.5 rounded-lg border text-sm font-bold transition ${fundSources['其他'] ? 'bg-blue-100 border-blue-500 text-blue-700' : 'border-slate-200 text-slate-500 hover:bg-slate-50'}`}>
                                                                                                    {fundSources['其他'] && <i className="fas fa-check mr-1 text-xs"></i>}其他
                                                                                                </button>
                                                                                            </div>
                                                                                        </div>
                                                                                    )}

                                                                                    {/* ★★★ D1: 簽章方式 tab ★★★ */}
                                                                                    {/* 自然人 hybrid → 顯示兩個 tab */}
                                                                                    {type === 'natural' && isHybrid && (
                                                                                        <div className="bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden">
                                                                                            <h4 className="font-bold px-4 pt-4 pb-2 text-slate-700 text-sm">簽章方式</h4>
                                                                                            <div className="flex border-b border-slate-200">
                                                                                                <button onClick={() => setSignMethod('online')} className={`flex-1 py-2.5 text-sm font-bold transition border-b-2 ${signMethod === 'online' ? 'border-blue-500 text-blue-700 bg-blue-50/50' : 'border-transparent text-slate-400 hover:text-slate-600'}`}>
                                                                                                    <i className="fas fa-pen-nib mr-1"></i>數位簽名
                                                                                                </button>
                                                                                                <button onClick={() => setSignMethod('paper')} className={`flex-1 py-2.5 text-sm font-bold transition border-b-2 ${signMethod === 'paper' ? 'border-blue-500 text-blue-700 bg-blue-50/50' : 'border-transparent text-slate-400 hover:text-slate-600'}`}>
                                                                                                    <i className="fas fa-print mr-1"></i>紙本簽名
                                                                                                </button>
                                                                                            </div>
                                                                                            <div className="p-4">
                                                                                                {signMethod === 'online' ? (
                                                                                                    <div className="space-y-4">
                                                                                                        <SignatureCanvas onSave={setSignatureImg} onClear={() => setSignatureImg(null)} />
                                                                                                        <button onClick={async () => {
                                                                                                            if (isAmlDoc && !hasFundSourcesSelected()) { alert('請先勾選至少一項出資金額來源！'); return; }
                                                                                                            if (shareholderInfo.docStatuses[doc.id] && !confirm('此文件已簽核過，確定要重新送出嗎？')) return;
                                                                                                            const data = await handleGenerateDoc(doc.id, { signatureImage: signatureImg, isSigned: true });
                                                                                                            if (data) alert('簽核版已產生並儲存！');
                                                                                                        }} disabled={!signatureImg || isProcessing} className="w-full bg-blue-600 text-white py-3 rounded-lg font-bold hover:bg-blue-700 shadow-md disabled:opacity-50 transition">
                                                                                                            {isProcessing ? <i className="fas fa-spinner fa-spin"></i> : <><i className="fas fa-paper-plane mr-2"></i>送出簽核</>}
                                                                                                        </button>
                                                                                                    </div>
                                                                                                ) : (
                                                                                                    <div className="space-y-3">
                                                                                                        <div className="bg-yellow-50 p-3 rounded-lg text-sm text-yellow-800 border border-yellow-200">
                                                                                                            <i className="fas fa-info-circle mr-1"></i>請先下載文件，列印簽名後再上傳
                                                                                                        </div>
                                                                                                        <button onClick={() => handleGeneratePDF('download', doc.id)} className="w-full border border-slate-300 text-slate-600 py-3 rounded-lg font-bold hover:bg-slate-50 transition flex items-center justify-center shadow-sm">
                                                                                                            <i className="fas fa-download mr-2"></i>下載 PDF
                                                                                                        </button>
                                                                                                        <div className="space-y-2 pt-2">
                                                                                                            <button onClick={() => document.getElementById(`file-upload-${doc.id}`).click()} className="w-full border border-slate-300 text-slate-600 py-3 rounded-lg font-bold hover:bg-slate-50 transition flex items-center justify-center gap-2">
                                                                                                                <i className="fas fa-file-upload"></i><span>選擇檔案上傳</span>
                                                                                                            </button>
                                                                                                            <button onClick={() => document.getElementById(`camera-upload-${doc.id}`).click()} className="w-full border border-green-300 text-green-700 py-3 rounded-lg font-bold hover:bg-green-50 transition flex items-center justify-center gap-2">
                                                                                                                <i className="fas fa-camera"></i><span>拍照上傳</span>
                                                                                                            </button>
                                                                                                            <input id={`file-upload-${doc.id}`} type="file" accept="image/*,application/pdf" multiple onChange={(e) => handleFileUpload(e, doc.id)} className="hidden" />
                                                                                                            <input id={`camera-upload-${doc.id}`} type="file" accept="image/*" capture="environment" onChange={(e) => handleFileUpload(e, doc.id)} className="hidden" />
                                                                                                            <p className="text-xs text-slate-400 text-center">支援 PDF、JPG、PNG，可選多張圖片合併</p>
                                                                                                            {pendingImages[doc.id] && pendingImages[doc.id].length > 0 && (
                                                                                                                <div className="mt-3 p-3 bg-blue-50 rounded-lg border border-blue-200">
                                                                                                                    <div className="flex items-center justify-between mb-2">
                                                                                                                        <span className="text-sm font-bold text-blue-700"><i className="fas fa-images mr-1"></i>已選 {pendingImages[doc.id].length} 張圖片</span>
                                                                                                                        <button onClick={() => setPendingImages(prev => { const n = { ...prev }; delete n[doc.id]; return n; })} className="text-xs text-red-500 hover:text-red-700"><i className="fas fa-trash mr-1"></i>清除</button>
                                                                                                                    </div>
                                                                                                                    <div className="flex gap-2 overflow-x-auto pb-2">
                                                                                                                        {pendingImages[doc.id].map((img, idx) => (
                                                                                                                            <img key={idx} src={img.preview} className="w-16 h-20 object-cover rounded border border-blue-300 flex-shrink-0" />
                                                                                                                        ))}
                                                                                                                    </div>
                                                                                                                    <button onClick={() => document.getElementById(`file-upload-${doc.id}`).click()} className="w-full mt-1 text-xs text-blue-600 hover:text-blue-800 py-1"><i className="fas fa-plus mr-1"></i>繼續加圖</button>
                                                                                                                    <button onClick={() => handleMergeUpload(doc.id)} disabled={isProcessing} className="w-full mt-2 bg-blue-600 text-white py-2.5 rounded-lg font-bold hover:bg-blue-700 disabled:opacity-50 transition flex items-center justify-center gap-2">
                                                                                                                        {isProcessing ? <i className="fas fa-spinner fa-spin"></i> : <><i className="fas fa-file-pdf mr-1"></i>合併為 PDF 並上傳</>}
                                                                                                                    </button>
                                                                                                                </div>
                                                                                                            )}
                                                                                                        </div>
                                                                                                    </div>
                                                                                                )}
                                                                                            </div>
                                                                                        </div>
                                                                                    )}

                                                                                    {/* 法人 hybrid → 只顯示紙本流程（大小章蓋印上傳） */}
                                                                                    {type === 'legal' && isHybrid && (
                                                                                        <div className="bg-white p-4 rounded-xl shadow-sm border border-slate-200 space-y-3">
                                                                                            <h4 className="font-bold text-slate-700 text-sm"><i className="fas fa-stamp mr-1"></i>用印簽核</h4>
                                                                                            <div className="bg-yellow-50 p-3 rounded-lg text-sm text-yellow-800 border border-yellow-200">
                                                                                                <i className="fas fa-info-circle mr-1"></i>請下載文件，蓋大小章後上傳
                                                                                            </div>
                                                                                            <button onClick={() => handleGeneratePDF('download', doc.id)} className="w-full border border-slate-300 text-slate-600 py-3 rounded-lg font-bold hover:bg-slate-50 transition flex items-center justify-center shadow-sm">
                                                                                                <i className="fas fa-download mr-2"></i>下載 PDF
                                                                                            </button>
                                                                                            <div className="space-y-2 pt-2">
                                                                                                <button onClick={() => document.getElementById(`file-upload-${doc.id}`).click()} className="w-full border border-slate-300 text-slate-600 py-3 rounded-lg font-bold hover:bg-slate-50 transition flex items-center justify-center gap-2">
                                                                                                    <i className="fas fa-file-upload"></i><span>選擇檔案</span>
                                                                                                </button>
                                                                                                <button onClick={() => document.getElementById(`camera-upload-${doc.id}`).click()} className="w-full border border-green-300 text-green-700 py-3 rounded-lg font-bold hover:bg-green-50 transition flex items-center justify-center gap-2">
                                                                                                    <i className="fas fa-camera"></i><span>拍照上傳</span>
                                                                                                </button>
                                                                                                <input id={`file-upload-${doc.id}`} type="file" accept="image/*,application/pdf" multiple onChange={(e) => handleFileUpload(e, doc.id)} className="hidden" />
                                                                                                <input id={`camera-upload-${doc.id}`} type="file" accept="image/*" capture="environment" onChange={(e) => handleFileUpload(e, doc.id)} className="hidden" />
                                                                                                <p className="text-xs text-slate-400 text-center">支援 PDF、JPG、PNG，可選多張圖片合併</p>
                                                                                                {pendingImages[doc.id] && pendingImages[doc.id].length > 0 && (
                                                                                                    <div className="mt-3 p-3 bg-blue-50 rounded-lg border border-blue-200">
                                                                                                        <div className="flex items-center justify-between mb-2">
                                                                                                            <span className="text-sm font-bold text-blue-700"><i className="fas fa-images mr-1"></i>已選 {pendingImages[doc.id].length} 張圖片</span>
                                                                                                            <button onClick={() => setPendingImages(prev => { const n = { ...prev }; delete n[doc.id]; return n; })} className="text-xs text-red-500 hover:text-red-700"><i className="fas fa-trash mr-1"></i>清除</button>
                                                                                                        </div>
                                                                                                        <div className="flex gap-2 overflow-x-auto pb-2">
                                                                                                            {pendingImages[doc.id].map((img, idx) => (
                                                                                                                <img key={idx} src={img.preview} className="w-16 h-20 object-cover rounded border border-blue-300 flex-shrink-0" />
                                                                                                            ))}
                                                                                                        </div>
                                                                                                        <button onClick={() => document.getElementById(`file-upload-${doc.id}`).click()} className="w-full mt-1 text-xs text-blue-600 hover:text-blue-800 py-1"><i className="fas fa-plus mr-1"></i>繼續加圖</button>
                                                                                                        <button onClick={() => handleMergeUpload(doc.id)} disabled={isProcessing} className="w-full mt-2 bg-blue-600 text-white py-2.5 rounded-lg font-bold hover:bg-blue-700 disabled:opacity-50 transition flex items-center justify-center gap-2">
                                                                                                            {isProcessing ? <i className="fas fa-spinner fa-spin"></i> : <><i className="fas fa-file-pdf mr-1"></i>合併為 PDF 並上傳</>}
                                                                                                        </button>
                                                                                                    </div>
                                                                                                )}
                                                                                            </div>
                                                                                        </div>
                                                                                    )}

                                                                                </>}
                                                                                    {/* paper_only (doc_offset) → 只有下載 + 提示繳回正本 */}
                                                                                    {isPaperOnly && (
                                                                                        <div className="bg-white p-4 rounded-xl shadow-sm border border-slate-200 space-y-3">
                                                                                            <button onClick={() => handleGeneratePDF('download', doc.id)} className="w-full border border-slate-300 text-slate-600 py-3 rounded-lg font-bold hover:bg-slate-50 transition flex items-center justify-center shadow-sm">
                                                                                                <i className="fas fa-download mr-2"></i>下載 PDF
                                                                                            </button>
                                                                                            {isMobile && (
                                                                                            <button onClick={() => handleGeneratePDF('share', doc.id)} className="w-full bg-[#06C755] text-white py-3 rounded-lg font-bold hover:bg-[#05b54d] transition flex items-center justify-center shadow-sm">
                                                                                                <i className="fab fa-line mr-2"></i>Line 分享
                                                                                            </button>
                                                                                            )}
                                                                                        </div>
                                                                                    )}

                                                                                    {/* ★★★ 文件產生狀態顯示 ★★★ */}
                                                                                    {docGenResults[doc.id] && (
                                                                                        <div className={`p-2.5 rounded text-xs ${docGenResults[doc.id].success ? 'bg-green-50 text-green-700 border border-green-200' : 'bg-red-50 text-red-700 border border-red-200'}`}>
                                                                                            <i className={`fas ${docGenResults[doc.id].success ? 'fa-check-circle' : 'fa-times-circle'} mr-1`}></i>
                                                                                            {docGenResults[doc.id].success ? '原檔已產生' : (docGenResults[doc.id].error || '產生失敗')}
                                                                                        </div>
                                                                                    )}
                                                                                    {docGenResults[doc.id + '_signed'] && (
                                                                                        <div className="p-2.5 rounded text-xs bg-green-50 text-green-700 border border-green-200">
                                                                                            <i className="fas fa-check-circle mr-1"></i>簽核版已上傳
                                                                                        </div>
                                                                                    )}

                                                                                    {/* doc_offset 特殊：股務確認狀態 */}
                                                                                    {doc.id === 'doc_offset' && shareholderInfo.docOffsetConfirmed && (
                                                                                        <div className="p-3 rounded-lg bg-green-50 text-green-700 border border-green-200 flex items-center gap-2">
                                                                                            <i className="fas fa-check-circle text-lg"></i>
                                                                                            <span className="font-bold text-sm">股務已確認繳交</span>
                                                                                        </div>
                                                                                    )}

                                                                                    {/* doc_offset 特殊：繳回正本提示 */}
                                                                                    {doc.id === 'doc_offset' && !shareholderInfo.docOffsetConfirmed && (
                                                                                        <div className="bg-red-50 p-4 rounded-lg border border-red-200">
                                                                                            <p className="text-red-700 font-bold text-sm flex items-center"><i className="fas fa-exclamation-triangle mr-2"></i>本文件需繳回正本</p>
                                                                                            <p className="text-sm text-red-600 mt-2">請於股東會現場交付，或郵寄正本：</p>
                                                                                            <div className="mt-3 bg-white p-3 rounded border border-red-100 text-sm text-slate-700 space-y-1">
                                                                                                <div><span className="font-bold">收件人：</span>陳英傑</div>
                                                                                                <div><span className="font-bold">手　機：</span>0912-754-402</div>
                                                                                                <div className="mt-1"><span className="font-bold">地址：</span>文山指南郵局 i郵箱（箱體編號 #2233）</div>
                                                                                                <div className="text-xs text-slate-400 mt-1 ml-8">參考地址：116台北市文山區指南路2段115號</div>
                                                                                            </div>
                                                                                        </div>
                                                                                    )}
                                                                                </div>
                                                                            </div>
                                                                        </div>
                                                                    </div>
                                                                </div>
                                                            );
                                                        })}
                                                    </div>
                                                </div>
                                            )}
                                        </div>
                                    )}
                                    </div>
                                    )}

                                    {/* 隱藏渲染區已移除，改用後端 Gotenberg 產 PDF */}
                                </div>
                            </div>
                        )}


                        {/* Tab 4: Shareholder Meeting Docs */}
                        {activeTab === 'meeting_docs' && (
                            <div className="p-4 sm:p-8 fade-in">
                                <h2 className="text-xl sm:text-2xl font-bold mb-6 text-slate-700 border-l-4 border-blue-600 pl-4">股東會文件</h2>

                                {getTabStatus('meeting_docs') === 'construction' ? (
                                    <div className="flex flex-col items-center justify-center py-20">
                                        <div className="w-20 h-20 bg-orange-100 text-orange-400 rounded-full flex items-center justify-center mb-6 text-3xl"><i className="fas fa-hard-hat"></i></div>
                                        <h3 className="text-xl font-bold text-slate-600 mb-2">功能建置中</h3>
                                        <p className="text-slate-500">此功能尚在準備中，敬請期待。</p>
                                    </div>
                                ) : !isVerified ? (
                                    <div className="flex flex-col items-center justify-center py-20">
                                        <div className="w-20 h-20 bg-slate-100 text-slate-400 rounded-full flex items-center justify-center mb-6 text-3xl">
                                            <i className="fas fa-lock"></i>
                                        </div>
                                        <h3 className="text-xl font-bold text-slate-600 mb-2">需要身份驗證</h3>
                                        <p className="text-slate-500 mb-6">請先至頁籤1完成身份驗證後，即可使用股東會功能。</p>
                                        <button onClick={() => setActiveTab('identity')} className="bg-blue-600 text-white px-8 py-3 rounded-lg font-bold hover:bg-blue-700 transition shadow-md">
                                            <i className="fas fa-arrow-left mr-2"></i>前往身份驗證
                                        </button>
                                    </div>
                                ) : (
                                    <div className="space-y-8">
                                        {/* ===== 1. 線上報到 ===== */}
                                        {(() => {
                                            const checkinActive = config.checkinEnabled === 'active';
                                            const checkinNotStarted = isNotStarted(config.checkinStartTime);
                                            const checkinExpired = isExpired(config.checkinDeadline);
                                            return (
                                        <div className="bg-white border border-slate-200 rounded-xl shadow-sm overflow-hidden">
                                            <div className="bg-blue-50 p-4 border-b border-blue-100">
                                                <h3 className="font-bold text-lg text-blue-800 flex items-center">
                                                    <i className="fas fa-qrcode mr-3 text-blue-500"></i>線上報到
                                                    <span className="ml-auto text-xs text-slate-500 font-normal">
                                                        {config.checkinStartTime && `開放：${config.checkinStartTime}`}
                                                        {config.checkinStartTime && config.checkinDeadline && ' ～ '}
                                                        {config.checkinDeadline && `截止：${config.checkinDeadline}`}
                                                    </span>
                                                </h3>
                                            </div>
                                            <div className="p-6">
                                                {!checkinActive ? (
                                                    <div className="text-center py-6 text-slate-500">
                                                        <i className="fas fa-clock text-3xl text-slate-300 mb-3"></i>
                                                        <p className="font-bold">報到功能尚未開放</p>
                                                    </div>
                                                ) : checkinNotStarted ? (
                                                    <div className="text-center py-6 text-slate-500">
                                                        <i className="fas fa-clock text-3xl text-amber-300 mb-3"></i>
                                                        <p className="font-bold text-amber-600">報到尚未開放</p>
                                                        <p className="text-sm mt-1">開放時間：{config.checkinStartTime}</p>
                                                    </div>
                                                ) : checkinExpired ? (
                                                    <div className="text-center py-6 text-slate-500">
                                                        <i className="fas fa-hourglass-end text-3xl text-red-300 mb-3"></i>
                                                        <p className="font-bold text-red-500">報到已截止</p>
                                                    </div>
                                                ) : checkinStatus ? (
                                                    <div className="text-center py-6">
                                                        <div className="w-16 h-16 bg-green-100 text-green-600 rounded-full flex items-center justify-center mx-auto mb-4 text-2xl">
                                                            <i className="fas fa-check-circle"></i>
                                                        </div>
                                                        <h4 className="text-xl font-bold text-green-700 mb-2">已完成報到</h4>
                                                        <p className="text-slate-500">
                                                            出席方式：<span className="font-bold text-slate-700">{checkinStatus === 'online' ? '線上出席' : '實體出席'}</span>
                                                        </p>
                                                        <p className="text-xs text-slate-400 mt-2">股東戶號: {shareholderId} | {name}</p>
                                                    </div>
                                                ) : (
                                                    <div className="text-center py-4">
                                                        <p className="text-slate-600 mb-6">請選擇您的出席方式：</p>
                                                        <div className="flex flex-col sm:flex-row gap-4 max-w-md mx-auto">
                                                            <button
                                                                onClick={() => handleCheckin('physical')}
                                                                disabled={isProcessing}
                                                                className="flex-1 bg-emerald-600 text-white py-4 px-6 rounded-xl font-bold hover:bg-emerald-700 transition shadow-md disabled:opacity-50 flex flex-col items-center gap-2"
                                                            >
                                                                <i className="fas fa-building text-2xl"></i>
                                                                <span>實體出席</span>
                                                            </button>
                                                            <button
                                                                onClick={() => handleCheckin('online')}
                                                                disabled={isProcessing}
                                                                className="flex-1 bg-blue-600 text-white py-4 px-6 rounded-xl font-bold hover:bg-blue-700 transition shadow-md disabled:opacity-50 flex flex-col items-center gap-2"
                                                            >
                                                                <i className="fas fa-laptop text-2xl"></i>
                                                                <span>線上出席</span>
                                                            </button>
                                                        </div>
                                                    </div>
                                                )}
                                            </div>
                                        </div>
                                            );
                                        })()}

                                        {/* ===== 2. 電子投票 ===== */}
                                        {(() => {
                                            const voteActive = config.voteEnabled === 'active';
                                            const voteNotStarted = isNotStarted(config.voteStartTime);
                                            const voteExpired = isExpired(config.voteDeadline);
                                            const dynamicProposals = config.proposals || [];
                                            const allVoted = dynamicProposals.length > 0 && dynamicProposals.every(p => votes[p.id]);
                                            const choiceLabelMap = { agree: '贊成', oppose: '反對', abstain: '棄權' };
                                            const choiceIconMap = { agree: 'fa-thumbs-up', oppose: 'fa-thumbs-down', abstain: 'fa-minus-circle' };
                                            const choiceColorMap = {
                                                agree: { active: 'bg-green-100 border-green-500 text-green-700', text: 'text-green-600' },
                                                oppose: { active: 'bg-red-100 border-red-500 text-red-700', text: 'text-red-600' },
                                                abstain: { active: 'bg-yellow-100 border-yellow-500 text-yellow-700', text: 'text-yellow-600' }
                                            };
                                            return (
                                        <div className="bg-white border border-slate-200 rounded-xl shadow-sm overflow-hidden">
                                            <div className="bg-purple-50 p-4 border-b border-purple-100">
                                                <h3 className="font-bold text-lg text-purple-800 flex items-center">
                                                    <i className="fas fa-vote-yea mr-3 text-purple-500"></i>電子投票
                                                    <span className="ml-auto text-xs text-slate-500 font-normal">
                                                        {config.voteStartTime && `開放：${config.voteStartTime}`}
                                                        {config.voteStartTime && config.voteDeadline && ' ～ '}
                                                        {config.voteDeadline && `截止：${config.voteDeadline}`}
                                                    </span>
                                                </h3>
                                            </div>
                                            <div className="p-6">
                                                {!voteActive ? (
                                                    <div className="text-center py-6 text-slate-500">
                                                        <i className="fas fa-clock text-3xl text-slate-300 mb-3"></i>
                                                        <p className="font-bold">投票功能尚未開放</p>
                                                    </div>
                                                ) : voteNotStarted ? (
                                                    <div className="text-center py-6 text-slate-500">
                                                        <i className="fas fa-clock text-3xl text-amber-300 mb-3"></i>
                                                        <p className="font-bold text-amber-600">投票尚未開放</p>
                                                        <p className="text-sm mt-1">開放時間：{config.voteStartTime}</p>
                                                    </div>
                                                ) : voteExpired ? (
                                                    <div className="text-center py-6 text-slate-500">
                                                        <i className="fas fa-hourglass-end text-3xl text-red-300 mb-3"></i>
                                                        <p className="font-bold text-red-500">投票已截止</p>
                                                    </div>
                                                ) : isVoteSubmitted ? (
                                                    <div className="text-center py-6">
                                                        <div className="w-16 h-16 bg-green-100 text-green-600 rounded-full flex items-center justify-center mx-auto mb-4 text-2xl">
                                                            <i className="fas fa-check-circle"></i>
                                                        </div>
                                                        <h4 className="text-xl font-bold text-green-700 mb-4">投票已送出</h4>
                                                        <div className="max-w-sm mx-auto text-left space-y-2">
                                                            {dynamicProposals.map(p => (
                                                                <div key={p.id} className="flex justify-between items-center bg-slate-50 p-3 rounded-lg text-sm">
                                                                    <span className="text-slate-600">{p.title}</span>
                                                                    <span className={`font-bold ${(choiceColorMap[votes[p.id]] || {}).text || 'text-slate-500'}`}>
                                                                        {choiceLabelMap[votes[p.id]] || votes[p.id] || '-'}
                                                                    </span>
                                                                </div>
                                                            ))}
                                                        </div>
                                                    </div>
                                                ) : (
                                                    <div className="space-y-6">
                                                        {dynamicProposals.map(proposal => (
                                                            <div key={proposal.id} className="bg-slate-50 p-5 rounded-xl border border-slate-200">
                                                                <h4 className="font-bold text-slate-700 mb-4">{proposal.title}</h4>
                                                                <div className="flex gap-3">
                                                                    {(proposal.options || ['贊成', '反對', '棄權']).map(opt => {
                                                                        const optKey = opt === '贊成' ? 'agree' : opt === '反對' ? 'oppose' : opt === '棄權' ? 'abstain' : opt;
                                                                        const isSelected = votes[proposal.id] === optKey;
                                                                        const colors = choiceColorMap[optKey] || { active: 'bg-blue-100 border-blue-500 text-blue-700' };
                                                                        return (
                                                                            <button
                                                                                key={optKey}
                                                                                onClick={() => setVotes(prev => ({ ...prev, [proposal.id]: optKey }))}
                                                                                className={`flex-1 py-3 px-4 rounded-lg border-2 font-bold transition text-sm flex flex-col items-center gap-1
                                                                                    ${isSelected ? colors.active : 'bg-white border-slate-200 text-slate-500 hover:border-slate-300'}`}
                                                                            >
                                                                                <i className={`fas ${choiceIconMap[optKey] || 'fa-check'}`}></i>{opt}
                                                                            </button>
                                                                        );
                                                                    })}
                                                                </div>
                                                            </div>
                                                        ))}

                                                        <button
                                                            onClick={handleVoteSubmit}
                                                            disabled={isProcessing || !allVoted}
                                                            className="w-full bg-purple-600 text-white py-4 rounded-xl font-bold hover:bg-purple-700 transition shadow-md disabled:opacity-50"
                                                        >
                                                            {isProcessing ? <i className="fas fa-spinner fa-spin"></i> : <><i className="fas fa-paper-plane mr-2"></i>送出投票</>}
                                                        </button>
                                                        <p className="text-xs text-slate-400 text-center">送出後不可修改，請確認後再送出</p>
                                                    </div>
                                                )}
                                            </div>
                                        </div>
                                            );
                                        })()}

                                        {/* ===== 3. 文件瀏覽 ===== */}
                                        <div className="bg-white border border-slate-200 rounded-xl shadow-sm overflow-hidden">
                                            <div className="bg-slate-50 p-4 border-b border-slate-200">
                                                <h3 className="font-bold text-lg text-slate-700 flex items-center">
                                                    <i className="fas fa-file-alt mr-3 text-slate-500"></i>會議文件瀏覽
                                                </h3>
                                            </div>
                                            <div className="p-6">
                                                <div className="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
                                                    {(config.meetingDocs || []).map(doc => (
                                                        <div
                                                            key={doc.id}
                                                            onClick={() => setViewingDoc(viewingDoc === doc.id ? null : doc.id)}
                                                            className={`p-5 rounded-xl border-2 cursor-pointer transition-all ${viewingDoc === doc.id ? 'border-blue-500 bg-blue-50 shadow-md' : 'border-slate-200 bg-white hover:border-blue-300 hover:shadow-sm'}`}
                                                        >
                                                            <div className="flex items-start gap-4">
                                                                <div className={`text-3xl ${viewingDoc === doc.id ? 'text-blue-500' : 'text-slate-300'}`}>
                                                                    <i className="fas fa-file-pdf"></i>
                                                                </div>
                                                                <div>
                                                                    <h4 className={`font-bold ${viewingDoc === doc.id ? 'text-blue-800' : 'text-slate-700'}`}>{doc.title}</h4>
                                                                    <p className="text-xs text-slate-500 mt-1">{doc.desc}</p>
                                                                </div>
                                                            </div>
                                                        </div>
                                                    ))}
                                                </div>

                                                {viewingDoc && (() => {
                                                    const selectedDoc = (config.meetingDocs || []).find(d => d.id === viewingDoc);
                                                    if (!selectedDoc || !selectedDoc.driveFileId) return null;
                                                    return (
                                                    <div className="fade-in">
                                                        <div className="bg-slate-100 rounded-xl overflow-hidden border border-slate-200">
                                                            <div className="flex justify-between items-center p-3 bg-slate-200">
                                                                <span className="text-sm font-bold text-slate-600">
                                                                    <i className="fas fa-eye mr-2"></i>{selectedDoc.title}
                                                                </span>
                                                                <button onClick={() => setViewingDoc(null)} className="text-slate-500 hover:text-slate-700 text-sm">
                                                                    <i className="fas fa-times mr-1"></i>關閉
                                                                </button>
                                                            </div>
                                                            <iframe
                                                                src={`https://drive.google.com/file/d/${selectedDoc.driveFileId}/preview`}
                                                                className="w-full border-0"
                                                                style={{ height: 'min(600px, 80vh)' }}
                                                                allow="autoplay"
                                                                title={selectedDoc.title}
                                                            ></iframe>
                                                        </div>
                                                        <p className="text-xs text-slate-400 text-center mt-2">如無法顯示，請確認您的網路連線或稍後再試</p>
                                                    </div>
                                                    );
                                                })()}
                                            </div>
                                        </div>
                                    </div>
                                )}
                            </div>
                        )}

                    </div >

                    {/* ★★★ 手機版文件預覽 全螢幕 Modal（iframe） ★★★ */}
                    {previewModalDocId && (
                        <div className="fixed inset-0 z-50 bg-black/60 flex flex-col" onClick={() => setPreviewModalDocId(null)}>
                            <div className="bg-white flex items-center justify-between px-4 py-3 shadow-md shrink-0" onClick={e => e.stopPropagation()}>
                                <h3 className="font-bold text-slate-800 text-sm truncate">
                                    {config.documents?.find(d => d.id === previewModalDocId)?.title || '文件預覽'}
                                </h3>
                                <button onClick={() => setPreviewModalDocId(null)} className="w-8 h-8 flex items-center justify-center rounded-full bg-slate-100 text-slate-600 hover:bg-slate-200">
                                    <i className="fas fa-times"></i>
                                </button>
                            </div>
                            <div className="flex-1 bg-white" onClick={e => e.stopPropagation()}>
                                {previewLoading[previewModalDocId] ? (
                                    <div className="flex items-center justify-center h-full">
                                        <i className="fas fa-spinner fa-spin text-3xl text-blue-400 mr-3"></i>
                                        <span className="text-slate-500">載入預覽中...</span>
                                    </div>
                                ) : previewHtmlMap[previewModalDocId] ? (
                                    <iframe
                                        srcDoc={previewHtmlMap[previewModalDocId]}
                                        className="w-full h-full border-0"
                                        title="文件預覽"
                                        sandbox="allow-same-origin"
                                    />
                                ) : (
                                    <div className="flex items-center justify-center h-full">
                                        <span className="text-slate-400">預覽載入失敗，請關閉後重試</span>
                                    </div>
                                )}
                            </div>
                        </div>
                    )}

                    <div className="text-center mt-10 text-slate-400 text-sm no-print">
                        © 2026 {config.systemName} <a href={config.n8nApiUrl + '?clearCache=8888'} target="_blank" className="text-slate-300 hover:text-slate-500" style={{textDecoration:'none'}}>CC</a> <a href="?admin=1" className="text-slate-300 hover:text-slate-500" style={{textDecoration:'none'}}>A</a>
                    </div>
                </div >
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>

</html>
