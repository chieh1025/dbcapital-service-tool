<!DOCTYPE html>
<html lang="zh-TW">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>股務小幫手</title>
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

    <style>
        /* 列印專用樣式表 */
        @media print {
            .no-print {
                display: none !important;
            }

            body {
                background: white !important;
                padding: 0 !important;
            }

            .card {
                box-shadow: none !important;
                border: none !important;
                padding: 0 !important;
                margin: 0 !important;
                width: 100% !important;
                max-width: 100% !important;
            }

            .print-only {
                display: block !important;
            }

            .print-border {
                border: 2px solid #000 !important;
            }

            #print-section {
                position: absolute;
                top: 0;
                left: 0;
                width: 100%;
                padding: 20px;
            }

            /* 列印時強制字體大小調整，確保清晰 */
            .print-text-lg {
                font-size: 14pt !important;
            }

            .print-text-xl {
                font-size: 16pt !important;
            }

            .print-text-2xl {
                font-size: 20pt !important;
            }
        }

        .fade-in {
            animation: fadeIn 0.5s ease-in-out;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
            }

            to {
                opacity: 1;
            }
        }

        /* Accordion transition */
        .accordion-content {
            transition: max-height 0.3s ease-out, opacity 0.3s ease-out;
            max-height: 0;
            opacity: 0;
            overflow: hidden;
        }

        .accordion-content.expanded {
            max-height: 800px;
            /* 足夠大的高度 */
            opacity: 1;
        }

        /* 簽名板樣式 */
        canvas.signature-pad {
            border: 2px dashed #cbd5e1;
            border-radius: 0.5rem;
            cursor: crosshair;
            background: #fff;
            width: 100%;
            touch-action: none;
            /* 防止手機滑動頁面 */
        }
    </style>
</head>

<body class="bg-gray-100 text-slate-800 font-sans min-h-screen flex items-center justify-center py-10">
    <div id="root" class="w-full max-w-5xl px-4"></div>

    <script type="text/babel">
        const { useState, useMemo, useEffect, useRef } = React;

        // ==========================================
        // ★★★ DEFAULT CONFIG 設定預設值 ★★★
        // ==========================================
        const DEFAULT_CONFIG = {
            systemName: "股務小幫手",
            companyName: "達飆資本",

            // ★★★ n8n Webhook URL (使用 Cloudflare Worker) ★★★
            n8nApiUrl: 'https://n8n-dbcapital-tool.chieh1025.workers.dev/',

            forceFullOffset: true,

            tax: { rate: 0.0211, threshold: 20000 },

            // ★★★ 股份種類定義 (對應 n8n 回傳的 key) ★★★
            shareTypes: [
                { id: 'voting_shares', name: '普通股/甲種特別股' },
                { id: 'preferred_yi', name: '乙種特別股' }
            ],

            dividends: [
                { id: 'div1', label: 'FY2025股利', amount: 55000 },
                { id: 'div2', label: '2026H1股利', amount: 15000 }
            ],

            subscriptionPrice: 115000,

            // ★★★ 股東戶號清單 (正式版：01~38，排除跳號) ★★★
            shareholderOptions: [
                { id: "01", label: "01 蔡**" },
                { id: "02", label: "02 郁*******" },
                { id: "03", label: "03 楊**" },
                { id: "04", label: "04 張**" },
                { id: "05", label: "05 楊**" },
                { id: "06", label: "06 崴*******" },
                { id: "08", label: "08 涂**" },
                { id: "09", label: "09 邱**" },
                { id: "10", label: "10 林*" },
                { id: "12", label: "12 茗*****" },
                { id: "13", label: "13 蔡**" },
                { id: "14", label: "14 王**" },
                { id: "15", label: "15 郭**" },
                { id: "16", label: "16 廖**" },
                { id: "18", label: "18 潘**" },
                { id: "19", label: "19 曾**" },
                { id: "20", label: "20 展***********" },
                { id: "21", label: "21 比*******" },
                { id: "22", label: "22 陳**" },
                { id: "23", label: "23 蕭**" },
                { id: "25", label: "25 謝**" },
                { id: "26", label: "26 金********" },
                { id: "27", label: "27 陳**" },
                { id: "28", label: "28 福*******" },
                { id: "30", label: "30 賴**" },
                { id: "31", label: "31 林**" },
                { id: "32", label: "32 許**" },
                { id: "33", label: "33 歐********" },
                { id: "34", label: "34 零*******" },
                { id: "35", label: "35 默********" },
                { id: "36", label: "36 林**" },
                { id: "37", label: "37 金*******" },
                { id: "38", label: "38 貝*********" },
                { id: "39", label: "39 赫*******" }
            ],

            documents: [
                { id: "doc1", title: "增資認購意願書" },
                { id: "doc2", title: "股東個資同意書 (預留)" },
                { id: "doc3", title: "放棄認購聲明書 (預留)" }
            ]
        };

        // --- 輔助函式 ---
        const formatMoney = (num) => new Intl.NumberFormat('zh-TW', { style: 'currency', currency: 'TWD', minimumFractionDigits: 0 }).format(num);
        const formatInput = (val) => {
            if (val === '' || val === undefined || val === null) return '';
            const str = val.toString();
            const parts = str.split('.');
            parts[0] = parts[0].replace(/\B(?=(\d{3})+(?!\d))/g, ",");
            return parts.join('.');
        };

        // ==========================================
        // ★★★ 簽名板元件 ★★★
        // ==========================================
        function SignatureCanvas({ onSave, onClear }) {
            const canvasRef = useRef(null);
            const [isDrawing, setIsDrawing] = useState(false);

            useEffect(() => {
                const canvas = canvasRef.current;
                if (!canvas) return;
                const ratio = Math.max(window.devicePixelRatio || 1, 1);
                canvas.width = canvas.offsetWidth * ratio;
                canvas.height = canvas.offsetHeight * ratio;
                canvas.getContext("2d").scale(ratio, ratio);
                const ctx = canvas.getContext('2d');
                ctx.strokeStyle = "#000";
                ctx.lineWidth = 2;
                ctx.lineCap = "round";
            }, []);

            const getPos = (e) => {
                const canvas = canvasRef.current;
                const rect = canvas.getBoundingClientRect();
                const x = (e.clientX || e.touches[0].clientX) - rect.left;
                const y = (e.clientY || e.touches[0].clientY) - rect.top;
                return { x, y };
            };

            const startDrawing = (e) => {
                e.preventDefault();
                setIsDrawing(true);
                const { x, y } = getPos(e);
                const ctx = canvasRef.current.getContext('2d');
                ctx.beginPath();
                ctx.moveTo(x, y);
            };

            const draw = (e) => {
                if (!isDrawing) return;
                e.preventDefault();
                const { x, y } = getPos(e);
                const ctx = canvasRef.current.getContext('2d');
                ctx.lineTo(x, y);
                ctx.stroke();
            };

            const stopDrawing = () => {
                if (isDrawing) {
                    setIsDrawing(false);
                    if (onSave) onSave(canvasRef.current.toDataURL());
                }
            };

            const clear = () => {
                const canvas = canvasRef.current;
                const ctx = canvas.getContext('2d');
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                ctx.beginPath();
                if (onClear) onClear();
            };

            return (
                <div className="relative">
                    <canvas
                        ref={canvasRef}
                        className="signature-pad h-48 w-full block"
                        onMouseDown={startDrawing}
                        onMouseMove={draw}
                        onMouseUp={stopDrawing}
                        onMouseLeave={stopDrawing}
                        onTouchStart={startDrawing}
                        onTouchMove={draw}
                        onTouchEnd={stopDrawing}
                    />
                    <button onClick={clear} className="absolute top-2 right-2 text-xs bg-gray-200 hover:bg-gray-300 px-2 py-1 rounded text-gray-600">
                        <i className="fas fa-eraser mr-1"></i>清除
                    </button>
                </div>
            );
        }

        // ==========================================
        // ★★★ 文件渲染元件 ★★★
        // ==========================================
        function DocumentPreview({ docId, data, signatureImg, config }) {
            const date = new Date();
            const sharesDetail = config.shareTypes.map(type => {
                const count = data.sharesMap?.[type.id] || 0;
                return count > 0 ? `${type.name} ${formatInput(count)} 股` : null;
            }).filter(Boolean).join('、');

            return (
                <div id={`doc-preview-${docId}`} className="bg-white p-10 border border-slate-300 shadow-sm mx-auto text-slate-900 leading-relaxed relative" style={{ width: '100%', maxWidth: '800px', minHeight: '800px' }}>
                    <div className="text-center mb-8 border-b-2 border-slate-800 pb-4">
                        <h2 className="text-2xl font-bold">{config.companyName}</h2>
                        <h3 className="text-xl font-bold mt-2">{config.documents.find(d => d.id === docId)?.title || "文件"}</h3>
                        <p className="text-sm text-slate-500 mt-1">文件編號: 2025-{docId.toUpperCase()}-{data.shareholderId || 'XXX'}</p>
                    </div>

                    {docId === 'doc1' && (
                        <div className="space-y-6 text-base">
                            <p><strong>立書人 (股東姓名)：</strong><u>&nbsp;&nbsp;{data.shareholderName || '____________'}&nbsp;&nbsp;</u><br /><strong>股東戶號：</strong><u>&nbsp;&nbsp;{data.shareholderId || '____________'}&nbsp;&nbsp;</u></p>
                            <p>茲確認本人持有貴公司股票共計 <strong>{formatInput(data.totalShares) || '0'}</strong> 股{sharesDetail && <span className="text-sm text-slate-600"> ({sharesDetail})</span>}，並同意參與貴公司 114 年度現金增資計畫。</p>
                            <table className="w-full border-collapse border border-slate-400 my-4 text-sm">
                                <thead><tr className="bg-slate-100"><th className="border border-slate-400 p-2">項目</th><th className="border border-slate-400 p-2">內容</th><th className="border border-slate-400 p-2">金額/股數</th></tr></thead>
                                <tbody>
                                    <tr><td className="border border-slate-400 p-2">現金股利抵繳</td><td className="border border-slate-400 p-2">同意以現金股利全額/部分抵充股款</td><td className="border border-slate-400 p-2">{formatMoney(data.offsetCost || 0)}</td></tr>
                                    <tr><td className="border border-slate-400 p-2">現金認購</td><td className="border border-slate-400 p-2">額外匯款認購股數</td><td className="border border-slate-400 p-2">{formatMoney(data.extraCost || 0)}</td></tr>
                                    <tr className="bg-slate-50 font-bold"><td className="border border-slate-400 p-2" colSpan="2">本次增資認購總股數</td><td className="border border-slate-400 p-2 text-blue-600">{formatInput(data.totalNewShares || 0)} 股</td></tr>
                                </tbody>
                            </table>
                            <p>本人瞭解並同意，上述認購款項若未於繳款期限內完成繳納 (含股利抵繳確認)，視同放棄本次認購權利。</p>
                            <div className="mt-12 pt-8">
                                <div className="flex justify-between items-end">
                                    <div className="w-1/2">
                                        <p className="mb-2 font-bold">股東簽章：</p>
                                        <div className="h-24 border-b border-slate-400 relative">
                                            {signatureImg ? <img src={signatureImg} className="h-full absolute bottom-0 left-0" alt="簽名" /> : <span className="text-slate-300 text-sm absolute bottom-2">請在此簽名或蓋章</span>}
                                        </div>
                                    </div>
                                    <div className="text-right"><p>中華民國 &nbsp;{date.getFullYear() - 1911}&nbsp; 年 &nbsp;{date.getMonth() + 1}&nbsp; 月 &nbsp;{date.getDate()}&nbsp; 日</p></div>
                                </div>
                            </div>
                        </div>
                    )}
                    {(docId !== 'doc1') && <div className="text-center py-20 text-slate-400"><i className="fas fa-file-contract text-6xl mb-4"></i><p>此文件範本尚未啟用</p></div>}
                    <div className="absolute bottom-4 left-0 w-full text-center text-xs text-slate-400">{config.systemName} - 電子文件系統</div>
                </div>
            );
        }

        // ==========================================
        // ★★★ Admin Panel 元件 ★★★
        // ==========================================
        function AdminPanel({ isOpen, onClose, config, onConfigChange }) {
            const [password, setPassword] = useState('');
            const [isAuthenticated, setIsAuthenticated] = useState(false);
            const [localConfig, setLocalConfig] = useState(config);

            useEffect(() => {
                if (isOpen) {
                    setLocalConfig(config);
                }
            }, [isOpen, config]);

            const handleLogin = () => {
                if (password === '8888') {
                    setIsAuthenticated(true);
                    setLocalConfig(config); // Reset local config to current
                } else {
                    alert('密碼錯誤');
                }
            };

            const handleSave = () => {
                onConfigChange(localConfig);
                onClose();
            };

            const updateDividend = (idx, field, val) => {
                const newDivs = [...localConfig.dividends];
                newDivs[idx][field] = val;
                setLocalConfig({ ...localConfig, dividends: newDivs });
            };

            if (!isOpen) return null;

            return (
                <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
                    <div className="bg-white rounded-lg p-6 w-full max-w-lg mx-4 shadow-2xl">
                        <div className="flex justify-between items-center mb-4">
                            <h2 className="text-xl font-bold text-slate-800">管理後台</h2>
                            <button onClick={onClose} className="text-slate-500 hover:text-slate-700"><i className="fas fa-times"></i></button>
                        </div>

                        {!isAuthenticated ? (
                            <div className="space-y-4">
                                <p className="text-sm text-slate-600">請輸入管理員密碼以修改參數配置。</p>
                                <input
                                    type="password"
                                    className="w-full p-2 border rounded"
                                    placeholder="輸入密碼"
                                    value={password}
                                    onChange={e => setPassword(e.target.value)}
                                    onKeyDown={e => e.key === 'Enter' && handleLogin()}
                                />
                                <button onClick={handleLogin} className="w-full bg-blue-600 text-white py-2 rounded hover:bg-blue-700">登入</button>
                            </div>
                        ) : (
                            <div className="space-y-4 max-h-[60vh] overflow-y-auto pr-2">
                                <div>
                                    <label className="block text-sm font-bold mb-1">公司名稱</label>
                                    <input
                                        type="text"
                                        className="w-full p-2 border rounded bg-slate-50"
                                        value={localConfig.companyName}
                                        onChange={e => setLocalConfig({ ...localConfig, companyName: e.target.value })}
                                    />
                                </div>
                                <div className="border-t pt-4">
                                    <h3 className="font-bold mb-2">股利設定</h3>
                                    {localConfig.dividends.map((div, idx) => (
                                        <div key={div.id} className="flex gap-2 mb-2">
                                            <input
                                                type="text"
                                                className="w-1/2 p-2 border rounded text-sm"
                                                value={div.label}
                                                onChange={e => updateDividend(idx, 'label', e.target.value)}
                                            />
                                            <input
                                                type="number"
                                                className="w-1/2 p-2 border rounded text-sm"
                                                value={div.amount}
                                                onChange={e => updateDividend(idx, 'amount', Number(e.target.value))}
                                            />
                                        </div>
                                    ))}
                                </div>
                                <div className="border-t pt-4">
                                    <h3 className="font-bold mb-2">增資設定</h3>
                                    <label className="block text-sm text-slate-600 mb-1">認購價格 (元/股)</label>
                                    <input
                                        type="number"
                                        className="w-full p-2 border rounded"
                                        value={localConfig.subscriptionPrice}
                                        onChange={e => setLocalConfig({ ...localConfig, subscriptionPrice: Number(e.target.value) })}
                                    />
                                </div>
                                <div className="border-t pt-4">
                                    <h3 className="font-bold mb-2">稅務設定</h3>
                                    <div className="grid grid-cols-2 gap-2">
                                        <div>
                                            <label className="block text-xs text-slate-500">二代健保費率</label>
                                            <input
                                                type="number"
                                                step="0.0001"
                                                className="w-full p-2 border rounded"
                                                value={localConfig.tax.rate}
                                                onChange={e => setLocalConfig({ ...localConfig, tax: { ...localConfig.tax, rate: Number(e.target.value) } })}
                                            />
                                        </div>
                                        <div>
                                            <label className="block text-xs text-slate-500">起扣門檻</label>
                                            <input
                                                type="number"
                                                className="w-full p-2 border rounded"
                                                value={localConfig.tax.threshold}
                                                onChange={e => setLocalConfig({ ...localConfig, tax: { ...localConfig.tax, threshold: Number(e.target.value) } })}
                                            />
                                        </div>
                                    </div>
                                </div>
                                <div className="pt-4">
                                    <button onClick={handleSave} className="w-full bg-green-600 text-white py-2 rounded hover:bg-green-700 shadow">儲存設定</button>
                                </div>
                            </div>
                        )}
                    </div>
                </div>
            );
        }

        function App() {
            // App Config State
            const [config, setConfig] = useState(DEFAULT_CONFIG);
            const [activeTab, setActiveTab] = useState('identity'); // identity, net_value, calculation, capital_docs, meeting_docs
            const [isAdminOpen, setIsAdminOpen] = useState(false);

            // --- 核心資料 for 股東 ---
            const [name, setName] = useState('');
            const [shareholderId, setShareholderId] = useState('');

            // 驗證相關
            const [inputVerifyCode, setInputVerifyCode] = useState('');
            const [isVerified, setIsVerified] = useState(false);
            const [isVerifying, setIsVerifying] = useState(false);

            // 股份狀態
            const [sharesMap, setSharesMap] = useState(() => {
                const initial = {};
                config.shareTypes.forEach(t => initial[t.id] = '');
                return initial;
            });

            // 試算相關 State
            const [type, setType] = useState('natural');
            const [willingToOffset, setWillingToOffset] = useState(false);
            const [offsetShares, setOffsetShares] = useState('');
            const [additionalShares, setAdditionalShares] = useState('');
            const [isTimelineExpanded, setIsTimelineExpanded] = useState(false);

            // 文件區狀態
            const [selectedDocId, setSelectedDocId] = useState('doc1'); // 對於 CapitalDocs 預設
            const [signMethod, setSignMethod] = useState('online');
            const [signatureImg, setSignatureImg] = useState(null);
            const [isProcessing, setIsProcessing] = useState(false);
            const [isCapturing, setIsCapturing] = useState(false);


            // --- Handlers ---
            const handleNumChange = (setter) => (e) => {
                const raw = e.target.value.replace(/,/g, '');
                if (raw === '' || !isNaN(raw)) setter(raw);
            };

            const handleShareTypeChange = (typeId) => (e) => {
                if (isVerified) return;
                const raw = e.target.value.replace(/,/g, '');
                if (raw === '' || !isNaN(raw)) {
                    setSharesMap(prev => ({ ...prev, [typeId]: raw }));
                }
            };

            const handleShareholderSelect = (e) => {
                const sid = e.target.value;
                setShareholderId(sid);
                setIsVerified(false);
                setInputVerifyCode('');
                setName('');
                const resetShares = {};
                config.shareTypes.forEach(t => resetShares[t.id] = '');
                setSharesMap(resetShares);

                // Reset calc
                setWillingToOffset(false);
                setOffsetShares('');
                setAdditionalShares('');
            };

            const handleVerifyIdentity = async () => {
                if (!shareholderId) return;
                if (!inputVerifyCode) {
                    alert("請輸入驗證碼");
                    return;
                }
                setIsVerifying(true);

                if (config.n8nApiUrl) {
                    try {
                        const response = await fetch(config.n8nApiUrl, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ type: 'verify', shareholderId: shareholderId, code: inputVerifyCode })
                        });

                        if (!response.ok) throw new Error(`Status: ${response.status}`);
                        const data = await response.json();

                        if (data.success) {
                            setIsVerified(true);
                            setName(data.name);
                            if (data.shares) {
                                if (typeof data.shares === 'object') {
                                    setSharesMap(prev => ({ ...prev, ...data.shares }));
                                } else {
                                    const firstType = config.shareTypes[0].id;
                                    setSharesMap(prev => ({ ...prev, [firstType]: data.shares }));
                                }
                            }
                            alert(`驗證成功！歡迎 ${data.name} 股東。`);
                        } else {
                            alert("驗證失敗：驗證碼錯誤或系統無此資料。");
                            setInputVerifyCode('');
                        }
                    } catch (e) {
                        console.error(e);
                        alert(`驗證連線失敗: ${e.message}`);
                    }
                } else {
                    await new Promise(r => setTimeout(r, 1000));
                    if (inputVerifyCode === '1196' || inputVerifyCode === '8888') {
                        setIsVerified(true);
                        setName("蔡昀達 (測試)");
                        setSharesMap({ voting_shares: "2", preferred_yi: "0" });
                        alert("【測試模式】驗證成功！");
                    } else {
                        alert("【測試模式】驗證碼錯誤 (測試碼: 1196)");
                    }
                }
                setIsVerifying(false);
            };

            // Calculation Result Memo
            const result = useMemo(() => {
                let totalShares = 0;
                Object.values(sharesMap).forEach(val => { totalShares += (Number(val) || 0); });
                if (totalShares <= 0) return null;

                const dividendResults = config.dividends.map(setting => {
                    const gross = Math.floor(totalShares * setting.amount);
                    let hi = 0;
                    if (type === 'natural' && gross >= config.tax.threshold) hi = Math.floor(gross * config.tax.rate);
                    return { ...setting, gross, hi, net: gross - hi };
                });

                const totalNetDividend = dividendResults.reduce((sum, item) => sum + item.net, 0);
                let maxOffsetSharesPossible = 0;
                if (config.subscriptionPrice > 0) maxOffsetSharesPossible = Math.floor(totalNetDividend / config.subscriptionPrice);

                let finalOffsetShares = 0;
                let finalOffsetCost = 0;
                if (willingToOffset) {
                    let input = Number(offsetShares) || 0;
                    if (input > maxOffsetSharesPossible) input = maxOffsetSharesPossible;
                    finalOffsetShares = input;
                    finalOffsetCost = finalOffsetShares * config.subscriptionPrice;
                }

                let extraShares = Number(additionalShares) || 0;
                let extraCost = extraShares * config.subscriptionPrice;

                return {
                    totalShares, dividendResults, totalNetDividend, maxOffsetSharesPossible,
                    finalOffsetShares, finalOffsetCost, extraShares, extraCost,
                    totalNewShares: finalOffsetShares + extraShares,
                    totalCost: finalOffsetCost + extraCost,
                    remainingDividendCash: totalNetDividend - finalOffsetCost,
                    finalBalance: (totalNetDividend - finalOffsetCost) - extraCost
                };
            }, [sharesMap, config.dividends, config.subscriptionPrice, config.tax, type, willingToOffset, offsetShares, additionalShares]);

            // PDF/Image Handlers
            const handleGeneratePDF = async (action, targetDocId) => {
                if (!shareholderId) { alert("請先選擇股東身分！"); return; }
                if (!window.jspdf) { alert("PDF library not loaded"); return; }
                const { jsPDF } = window.jspdf;

                setIsProcessing(true);
                // Dynamically find element by ID based on passed docId or defaults
                const input = document.getElementById(`doc-preview-${targetDocId}`);
                if (!input) { alert("找不到文件元素"); setIsProcessing(false); return; }

                try {
                    const canvas = await html2canvas(input, { scale: 2, useCORS: true });
                    const imgData = canvas.toDataURL('image/png');
                    const pdf = new jsPDF('p', 'mm', 'a4');
                    const pdfWidth = pdf.internal.pageSize.getWidth();
                    const pdfHeight = (canvas.height * pdfWidth) / canvas.width;
                    pdf.addImage(imgData, 'PNG', 0, 0, pdfWidth, pdfHeight);

                    const docTitle = config.documents.find(d => d.id === targetDocId)?.title || targetDocId;
                    const filename = `${shareholderId}_${name}_${docTitle}.pdf`;

                    if (action === 'download') {
                        pdf.save(filename);
                        alert("文件已下載。");
                    } else if (action === 'submit') {
                        if (config.n8nApiUrl) {
                            const pdfBlob = pdf.output('blob');
                            const reader = new FileReader();
                            reader.readAsDataURL(pdfBlob);
                            reader.onloadend = async function () {
                                const base64data = reader.result;
                                try {
                                    await fetch(config.n8nApiUrl, {
                                        method: 'POST',
                                        headers: { 'Content-Type': 'application/json' },
                                        body: JSON.stringify({ type: 'submit_doc', shareholderId, filename, file: base64data })
                                    });
                                    alert(`已成功送出！`);
                                } catch (e) { alert("上傳失敗"); }
                            }
                        } else {
                            await new Promise(r => setTimeout(r, 1000));
                            alert(`【測試模式】已成功送出！`);
                        }
                    }
                } catch (err) { console.error(err); alert("文件生成失敗"); }
                setIsProcessing(false);
            };

            const handleFileUpload = async (e, type) => {
                const file = e.target.files[0];
                if (!file || !shareholderId) { alert("請先選擇股東身分！"); return; }
                setIsProcessing(true);
                // Implementation simplified for brevity: same as before
                if (config.n8nApiUrl) {
                    const reader = new FileReader();
                    reader.readAsDataURL(file);
                    reader.onloadend = async function () {
                        try {
                            await fetch(config.n8nApiUrl, {
                                method: 'POST',
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify({ type: 'proof' === type ? 'submit_proof' : 'submit_signed_paper', shareholderId, filename: file.name, file: reader.result })
                            });
                            alert("上傳成功");
                        } catch (e) { alert("上傳失敗"); }
                        setIsProcessing(false);
                    }
                } else {
                    setTimeout(() => { alert("測試上傳成功"); setIsProcessing(false); }, 1000);
                }
                e.target.value = '';
            };

            const handleDownloadImage = () => {
                const element = document.getElementById('print-section');
                if (!element) return;
                setIsCapturing(true);
                html2canvas(element, { scale: 2, backgroundColor: '#ffffff' }).then(canvas => {
                    const link = document.createElement('a');
                    link.href = canvas.toDataURL('image/png');
                    link.download = `股利試算確認單_${name}.png`;
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                    setIsCapturing(false);
                });
            };

            // --- TABS VISUAL ---
            const MenuItem = ({ id, label, icon }) => (
                <button
                    onClick={() => setActiveTab(id)}
                    className={`flex-1 py-4 text-center font-bold text-sm md:text-base border-b-4 transition duration-200 
                        ${activeTab === id ? 'border-blue-600 text-blue-600 bg-white' : 'border-transparent text-slate-400 hover:text-slate-600 hover:bg-slate-50'}`}
                >
                    <div className="mb-1 text-xl"><i className={`fas ${icon}`}></i></div>
                    {label}
                </button>
            );

            return (
                <div className="pb-20">
                    <header className="mb-6 flex justify-between items-center no-print pt-6 px-4">
                        <h1 className="text-3xl font-extrabold text-slate-800 tracking-tight">{config.systemName}</h1>
                        <button onClick={() => setIsAdminOpen(true)} className="text-slate-300 hover:text-slate-500 transition">
                            <i className="fas fa-cog text-xl"></i>
                        </button>
                    </header>

                    <div className="bg-white shadow-xl rounded-xl border border-slate-200 card overflow-hidden min-h-[600px]">

                        {/* Navigation Tabs */}
                        <div className="flex border-b border-slate-200 bg-slate-50/50 no-print overflow-x-auto">
                            <MenuItem id="identity" label="1. 身份驗證" icon="fa-id-card" />
                            <MenuItem id="net_value" label="2. 每月淨值" icon="fa-chart-line" />
                            <MenuItem id="calculation" label="3. 試算工具" icon="fa-calculator" />
                            <MenuItem id="capital_docs" label="4. 增資文件" icon="fa-file-signature" />
                            <MenuItem id="meeting_docs" label="5. 股東會文件" icon="fa-folder-open" />
                        </div>

                        {/* --- TAB CONTENT --- */}

                        {/* Tab 1: Identity */}
                        {activeTab === 'identity' && (
                            <div className="p-8 md:p-12 fade-in">
                                <h2 className="text-2xl font-bold mb-6 text-slate-700 border-l-4 border-blue-600 pl-4">股東身份驗證</h2>
                                <div className="max-w-md mx-auto space-y-8 py-8">
                                    {!isVerified ? (
                                        <div className="space-y-6 bg-slate-50 p-8 rounded-xl border border-slate-200 shadow-sm">
                                            <div>
                                                <label className="block text-sm font-bold text-slate-600 mb-2">選擇股東戶號</label>
                                                <select className="w-full p-4 border border-slate-300 rounded-lg bg-white text-lg focus:ring-2 focus:ring-blue-500 outline-none" value={shareholderId} onChange={handleShareholderSelect}>
                                                    <option value="">-- 請選擇 --</option>
                                                    {config.shareholderOptions.map(opt => (<option key={opt.id} value={opt.id}>{opt.label}</option>))}
                                                </select>
                                            </div>
                                            {shareholderId && (
                                                <div className="fade-in">
                                                    <label className="block text-sm font-bold text-slate-600 mb-2">輸入驗證碼</label>
                                                    <input type="password" placeholder="****" className="w-full p-4 border border-slate-300 rounded-lg text-lg outline-none focus:ring-2 focus:ring-blue-500 mb-4" value={inputVerifyCode} onChange={(e) => setInputVerifyCode(e.target.value)} />
                                                    <button onClick={handleVerifyIdentity} disabled={isVerifying} className="w-full bg-blue-600 text-white py-4 rounded-lg font-bold text-lg hover:bg-blue-700 transition disabled:opacity-50">
                                                        {isVerifying ? '驗證中...' : '開始驗證'}
                                                    </button>
                                                </div>
                                            )}
                                        </div>
                                    ) : (
                                        <div className="bg-green-50 border border-green-200 p-8 rounded-xl text-center fade-in">
                                            <div className="w-20 h-20 bg-green-100 text-green-600 rounded-full flex items-center justify-center mx-auto mb-4 text-3xl">
                                                <i className="fas fa-check"></i>
                                            </div>
                                            <h3 className="text-2xl font-bold text-green-800 mb-2">{name}</h3>
                                            <p className="text-green-600 mb-6">股東戶號: {shareholderId} | 驗證成功</p>

                                            <div className="grid grid-cols-2 gap-4 text-left bg-white p-4 rounded-lg border border-green-100 mb-6">
                                                {config.shareTypes.map(t => (
                                                    <div key={t.id}>
                                                        <div className="text-xs text-slate-500">{t.name}</div>
                                                        <div className="font-bold text-lg">{formatInput(sharesMap[t.id])} 股</div>
                                                    </div>
                                                ))}
                                            </div>

                                            <button onClick={() => setActiveTab('calculation')} className="w-full bg-blue-600 text-white py-3 rounded-lg font-bold hover:bg-blue-700 shadow-lg mb-3">
                                                前往股利試算 <i className="fas fa-arrow-right ml-2"></i>
                                            </button>
                                            <button onClick={() => { setIsVerified(false); setShareholderId(''); setName(''); }} className="text-slate-400 hover:text-slate-600 underline text-sm">
                                                登出 / 重新驗證
                                            </button>
                                        </div>
                                    )}
                                </div>
                            </div>
                        )}

                        {/* Tab 2: Monthly Net Value */}
                        {activeTab === 'net_value' && (
                            <div className="p-8 fade-in">
                                <h2 className="text-2xl font-bold mb-6 text-slate-700 border-l-4 border-blue-600 pl-4">公司每月淨值公告</h2>
                                <div className="overflow-x-auto">
                                    <table className="w-full text-left border-collapse">
                                        <thead>
                                            <tr className="bg-slate-100 text-slate-600">
                                                <th className="p-4 border-b">月份</th>
                                                <th className="p-4 border-b">每股淨值 (NAV)</th>
                                                <th className="p-4 border-b">月增減</th>
                                                <th className="p-4 border-b">備註</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            {/* 假資料，未來可改為動態 */}
                                            <tr className="hover:bg-slate-50"><td className="p-4 border-b">2026/01</td><td className="p-4 border-b font-mono font-bold text-blue-600">12.45</td><td className="p-4 border-b text-red-500">+1.2%</td><td className="p-4 border-b text-sm text-slate-500">-</td></tr>
                                            <tr className="hover:bg-slate-50"><td className="p-4 border-b">2025/12</td><td className="p-4 border-b font-mono font-bold text-slate-700">12.30</td><td className="p-4 border-b text-green-500">-0.5%</td><td className="p-4 border-b text-sm text-slate-500">年度結算</td></tr>
                                            <tr className="hover:bg-slate-50"><td className="p-4 border-b">2025/11</td><td className="p-4 border-b font-mono font-bold text-slate-700">12.36</td><td className="p-4 border-b text-red-500">+0.8%</td><td className="p-4 border-b text-sm text-slate-500">-</td></tr>
                                        </tbody>
                                    </table>
                                </div>
                                <p className="text-center text-slate-400 text-sm mt-8">資料更新時間: 2026/02/01</p>
                            </div>
                        )}

                        {/* Tab 3: Calculation (Existing Logic) */}
                        {activeTab === 'calculation' && (
                            <div className="fade-in">
                                <div className="p-8 md:p-10">
                                    <h2 className="text-2xl font-bold mb-6 text-slate-700 border-l-4 border-blue-600 pl-4">股利與增資試算</h2>

                                    {!isVerified && (
                                        <div className="bg-yellow-50 border-l-4 border-yellow-400 p-4 mb-8 text-yellow-800">
                                            <i className="fas fa-exclamation-triangle mr-2"></i> 請先至「身份驗證」頁籤完成登入，以自動帶入股數。
                                        </div>
                                    )}

                                    {/* Timeline Accordion */}
                                    <div className="bg-blue-50 border-l-4 border-blue-500 mb-10 rounded-r-lg shadow-sm no-print overflow-hidden">
                                        <div className="p-4 flex justify-between items-center cursor-pointer hover:bg-blue-100 transition-colors" onClick={() => setIsTimelineExpanded(!isTimelineExpanded)}>
                                            <h3 className="text-lg font-bold text-blue-800 flex items-center"><i className="fas fa-calendar-alt mr-3"></i>主要事件時程</h3>
                                            <div className="flex items-center text-blue-600 text-sm font-bold"><span className="mr-2">{isTimelineExpanded ? '收合' : '展開'}</span><i className={`fas fa-chevron-down transition-transform duration-300 ${isTimelineExpanded ? 'rotate-180' : ''}`}></i></div>
                                        </div>
                                        <div className={`accordion-content ${isTimelineExpanded ? 'expanded' : ''}`}>
                                            <div className="p-6 pt-0 border-t border-blue-100 mt-2">
                                                <ul className="space-y-3 text-slate-700 font-medium text-base list-disc pl-5">
                                                    <li>3/28 股東會通過應付股利</li>
                                                    <li>5月 調查增資意願及金額範圍</li>
                                                    <li>7/6 結帳公佈淨值與增資價格</li>
                                                    <li>7/20 增資收件截止</li>
                                                    <li>8/20 股利發放</li>
                                                </ul>
                                            </div>
                                        </div>
                                    </div>

                                    {/* Inputs */}
                                    <div className="grid grid-cols-1 md:grid-cols-2 gap-8 mb-8">
                                        <div className="bg-slate-50 p-6 rounded-xl border border-slate-200">
                                            <h4 className="font-bold text-slate-700 mb-4">持有股數</h4>
                                            <div className="space-y-4">
                                                {config.shareTypes.map(t => (
                                                    <div key={t.id}>
                                                        <label className="text-sm text-slate-500">{t.name}</label>
                                                        <input
                                                            type="text"
                                                            className={`w-full p-2 border rounded ${isVerified ? 'bg-slate-200' : 'bg-white'}`}
                                                            value={formatInput(sharesMap[t.id])}
                                                            onChange={handleShareTypeChange(t.id)}
                                                            readOnly={isVerified}
                                                            placeholder="0"
                                                        />
                                                    </div>
                                                ))}
                                                {result && <div className="text-right text-sm font-bold text-blue-600">總計: {formatInput(result.totalShares)} 股</div>}
                                            </div>
                                        </div>

                                        <div className="bg-slate-50 p-6 rounded-xl border border-slate-200 flex flex-col justify-center">
                                            <div className="flex gap-4 mb-6">
                                                <label className={`flex-1 p-3 border rounded text-center cursor-pointer ${type === 'natural' ? 'bg-blue-100 border-blue-500 text-blue-700 font-bold' : 'bg-white'}`}><input type="radio" checked={type === 'natural'} onChange={() => setType('natural')} className="hidden" />自然人</label>
                                                <label className={`flex-1 p-3 border rounded text-center cursor-pointer ${type === 'legal' ? 'bg-purple-100 border-purple-500 text-purple-700 font-bold' : 'bg-white'}`}><input type="radio" checked={type === 'legal'} onChange={() => setType('legal')} className="hidden" />法人</label>
                                            </div>
                                            <div className="text-xs text-slate-500">
                                                * 自然人單筆股利超過 $20,000 需扣 {config.tax.rate * 100}% 二代健保
                                            </div>
                                        </div>
                                    </div>

                                    {/* Results */}
                                    {result && (
                                        <div className="fade-in space-y-6">
                                            <div className="bg-white border rounded-xl shadow-sm p-6">
                                                <div className="flex justify-between items-center mb-4 border-b pb-4">
                                                    <span className="text-lg font-bold text-slate-700">可運用股利總淨額</span>
                                                    <span className="text-2xl font-bold text-blue-600">{formatMoney(result.totalNetDividend)}</span>
                                                </div>

                                                <label className="flex items-center gap-3 cursor-pointer mb-4">
                                                    <div className={`w-6 h-6 rounded border flex items-center justify-center ${willingToOffset ? 'bg-blue-600 border-blue-600 text-white' : 'border-slate-300'}`}>
                                                        {willingToOffset && <i className="fas fa-check text-xs"></i>}
                                                    </div>
                                                    <input type="checkbox" checked={willingToOffset} onChange={e => setWillingToOffset(e.target.checked)} className="hidden" />
                                                    <span className="font-bold">我願意以股利抵繳增資股款</span>
                                                </label>

                                                <div className={`transition-all duration-300 ${willingToOffset ? 'opacity-100 max-h-96' : 'opacity-50 max-h-0 overflow-hidden'}`}>
                                                    <div className="bg-green-50 p-4 rounded-lg flex justify-between items-center mb-4">
                                                        <div>
                                                            <label className="block text-green-800 font-bold text-sm">欲抵繳股數 (上限 {result.maxOffsetSharesPossible} 股)</label>
                                                            <input type="text" className="bg-transparent border-b-2 border-green-400 text-xl font-bold text-green-700 w-32 focus:outline-none" value={formatInput(offsetShares)} onChange={handleNumChange(setOffsetShares)} placeholder="0" />
                                                        </div>
                                                        <div className="text-right">
                                                            <div className="text-xs text-green-600">抵繳金額</div>
                                                            <div className="text-xl font-bold text-green-700">{formatMoney(result.finalOffsetCost)}</div>
                                                        </div>
                                                    </div>
                                                </div>

                                                <div className="bg-yellow-50 p-4 rounded-lg flex justify-between items-center">
                                                    <div>
                                                        <label className="block text-yellow-800 font-bold text-sm">額外現金認購股數</label>
                                                        <input type="text"
                                                            disabled={config.forceFullOffset && result.maxOffsetSharesPossible > 0 && (!willingToOffset || (Number(offsetShares) || 0) < result.maxOffsetSharesPossible)}
                                                            className="bg-transparent border-b-2 border-yellow-400 text-xl font-bold text-yellow-800 w-32 focus:outline-none disabled:opacity-50"
                                                            value={formatInput(additionalShares)}
                                                            onChange={handleNumChange(setAdditionalShares)}
                                                            placeholder="0"
                                                        />
                                                    </div>
                                                    <div className="text-right">
                                                        <div className="text-xs text-yellow-700">額外應補金額</div>
                                                        <div className="text-xl font-bold text-yellow-800">{formatMoney(result.extraCost)}</div>
                                                    </div>
                                                </div>
                                            </div>

                                            {/* Preview Card */}
                                            <div id="print-section" className="bg-white border-4 border-slate-800 rounded-xl p-8 print-border">
                                                <div className="text-center mb-4">
                                                    <h3 className="text-2xl font-bold">{config.companyName}</h3>
                                                    <p>試算確認單</p>
                                                </div>
                                                <div className="grid grid-cols-2 gap-4 text-sm md:text-base">
                                                    <div>姓名：{name}</div><div className="text-right">總持有：{formatInput(result.totalShares)} 股</div>
                                                    <div className="col-span-2 border-b border-dashed my-2"></div>
                                                    <div>1. 股利總淨額</div><div className="text-right font-bold text-blue-700">{formatMoney(result.totalNetDividend)}</div>
                                                    <div className="col-span-2 bg-slate-50 p-2 rounded text-xs text-slate-500">
                                                        {result.dividendResults.map((item) => (
                                                            <div key={item.id} className="flex justify-between">
                                                                <span>{item.label}:</span>
                                                                <span>{formatMoney(item.net)} <span className="scale-75 inline-block origin-right">(稅前 {formatMoney(item.gross)})</span></span>
                                                            </div>
                                                        ))}
                                                    </div>
                                                    <div>2. 認購新股 ({formatInput(result.totalNewShares)}股)</div><div className="text-right text-red-600">-{formatMoney(result.totalCost)}</div>
                                                    <div className="col-span-2 border-b border-black my-2"></div>
                                                    <div className="font-bold text-lg">應收付淨額</div>
                                                    <div className={`text-right font-bold text-2xl ${result.finalBalance >= 0 ? 'text-blue-700' : 'text-red-600'}`}>
                                                        {formatMoney(Math.abs(result.finalBalance))}
                                                        <span className="text-sm ml-1 text-slate-500">{result.finalBalance >= 0 ? '(公司應付)' : '(股東應補)'}</span>
                                                    </div>
                                                </div>
                                                <div className="text-center mt-6 no-print">
                                                    <button onClick={handleDownloadImage} disabled={isCapturing} className="bg-blue-600 text-white px-6 py-2 rounded-full shadow hover:bg-blue-700 text-sm">
                                                        {isCapturing ? '生成中...' : '下載確認單圖片'}
                                                    </button>
                                                </div>
                                            </div>
                                        </div>
                                    )}
                                </div>
                            </div>
                        )}

                        {/* Tab 4: Capital Docs */}
                        {activeTab === 'capital_docs' && (
                            <div className="p-8 fade-in">
                                <h2 className="text-2xl font-bold mb-6 text-slate-700 border-l-4 border-blue-600 pl-4">增資認購意願書</h2>

                                {!isVerified ? (
                                    <div className="text-center py-20 bg-slate-50 rounded-lg">
                                        <i className="fas fa-lock text-4xl text-slate-300 mb-4"></i>
                                        <p className="text-slate-500">請先進行身份驗證</p>
                                    </div>
                                ) : (
                                    <div className="flex flex-col lg:flex-row gap-8">
                                        <div className="lg:w-2/3 bg-slate-200 p-4 rounded-xl overflow-auto shadow-inner" style={{ maxHeight: '800px' }}>
                                            <DocumentPreview docId="doc1" data={{ shareholderId, shareholderName: name, sharesMap, totalShares: result?.totalShares, totalNewShares: result?.totalNewShares, offsetCost: result?.finalOffsetCost, extraCost: result?.extraCost }} signatureImg={signatureImg} config={config} />
                                        </div>
                                        <div className="lg:w-1/3 space-y-6">
                                            <div className="bg-white p-6 rounded-xl shadow-sm border border-slate-200">
                                                <h4 className="font-bold mb-4 text-slate-700">簽署方式</h4>
                                                <div className="flex gap-2 mb-4">
                                                    <button onClick={() => setSignMethod('online')} className={`flex-1 py-2 rounded-lg border text-sm font-bold ${signMethod === 'online' ? 'bg-blue-50 border-blue-500 text-blue-700' : 'border-slate-200 text-slate-500'}`}>線上簽核</button>
                                                    <button onClick={() => setSignMethod('paper')} className={`flex-1 py-2 rounded-lg border text-sm font-bold ${signMethod === 'paper' ? 'bg-blue-50 border-blue-500 text-blue-700' : 'border-slate-200 text-slate-500'}`}>紙本上傳</button>
                                                </div>

                                                {signMethod === 'online' ? (
                                                    <div className="space-y-4">
                                                        <div><p className="text-sm text-slate-500 mb-2">請簽名：</p><SignatureCanvas onSave={setSignatureImg} onClear={() => setSignatureImg(null)} /></div>
                                                        <button onClick={() => handleGeneratePDF('submit', 'doc1')} disabled={!signatureImg || isProcessing} className="w-full bg-blue-600 text-white py-3 rounded-lg font-bold hover:bg-blue-700 shadow-md disabled:opacity-50">
                                                            {isProcessing ? <i className="fas fa-spinner fa-spin"></i> : '送出簽核'}
                                                        </button>
                                                    </div>
                                                ) : (
                                                    <div className="space-y-4">
                                                        <button onClick={() => handleGeneratePDF('download', 'doc1')} className="w-full border-2 border-slate-800 text-slate-800 py-3 rounded-lg font-bold hover:bg-slate-50">下載 PDF</button>
                                                        <div className="border-t pt-4">
                                                            <label className="block text-sm font-bold text-slate-700 mb-2">上傳已簽署文件</label>
                                                            <input type="file" accept="image/*,application/pdf" onChange={(e) => handleFileUpload(e, 'paper')} className="w-full text-sm text-slate-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:bg-blue-50 file:text-blue-700" />
                                                        </div>
                                                    </div>
                                                )}
                                            </div>
                                            <div className="bg-white p-6 rounded-xl shadow-sm border border-slate-200">
                                                <h4 className="font-bold mb-2">匯款憑證</h4>
                                                <input type="file" accept="image/*,application/pdf" onChange={(e) => handleFileUpload(e, 'proof')} className="w-full text-sm text-slate-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:bg-green-50 file:text-green-700" />
                                            </div>
                                        </div>
                                    </div>
                                )}
                            </div>
                        )}

                        {/* Tab 5: Shareholder Meeting Docs */}
                        {activeTab === 'meeting_docs' && (
                            <div className="p-8 fade-in">
                                <h2 className="text-2xl font-bold mb-6 text-slate-700 border-l-4 border-blue-600 pl-4">股東會文件</h2>
                                <div className="grid grid-cols-1 md:grid-cols-3 gap-6">
                                    {['doc2', 'doc3'].map(id => {
                                        const doc = config.documents.find(d => d.id === id);
                                        return (
                                            <div key={id} className="bg-white border rounded-xl p-6 shadow-sm hover:shadow-md transition">
                                                <div className="text-4xl text-slate-300 mb-4"><i className="fas fa-file-alt"></i></div>
                                                <h3 className="font-bold text-lg mb-2">{doc?.title}</h3>
                                                <p className="text-sm text-slate-500 mb-4">適用於 2025 股東常會</p>
                                                <button className="text-blue-600 font-bold hover:underline" onClick={() => alert("功能尚未開放")}>查看詳情</button>
                                            </div>
                                        );
                                    })}
                                </div>
                            </div>
                        )}

                    </div>

                    <AdminPanel
                        isOpen={isAdminOpen}
                        onClose={() => setIsAdminOpen(false)}
                        config={config}
                        onConfigChange={setConfig}
                    />

                    <div className="text-center mt-10 text-slate-400 text-sm no-print">
                        © 2025 {config.systemName} | 資料僅供試算，實際金額以公司正式通知為準
                    </div>
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>

</html>
